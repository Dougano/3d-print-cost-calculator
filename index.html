<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="3D Printing Business Cost Calculator for South Africa">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="PrintCalc">
    <title>3D Print Cost Calculator</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/pouchdb@8.0.1/dist/pouchdb.min.js"></script>
    <style>
        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // Global state
        let state = {
            // PWA
            deferredPrompt: null,
            showInstallButton: false,
            
            // Calculator
            filamentType: 'PLA',
            customDensity: 1.20,
            filamentDiameter: 1.75,
            filamentLength: 1,
            filamentPrice: 450,
            filamentWeight: 1,
            printTime: 2,
            hourlyRate: 0,
            markup: 15,
            printerPower: 350,
            electricityRate: 3.50,
            maintenanceCostPerHour: 8.50,
            
            // Products
            products: [],
            productName: '',
            editingProduct: null,
            showMobileMenu: false,
            
            // Search and filtering
            searchQuery: '',
            selectedMaterial: '',
            sortOrder: 'date_desc', // date_desc, date_asc, price_desc, price_asc
            filteredProducts: [],
            
            // Auto-export settings
            autoExportEnabled: true,
            lastAutoExport: null,
            autoExportThreshold: 5, // Auto-export after 5 changes
            
            // Notifications
            notifications: [],
            
            // Cost overrides (removed)
        };

        // Filament types
        const filamentTypes = {
            ABS: { name: 'Acrylonitrile Butadiene Styrene', density: 1.05 },
            PLA: { name: 'Polylactic Acid', density: 1.27 },
            PETG: { name: 'Polyethylene Terephthalate', density: 1.25 },
            PETT: { name: 'T-Glase filament', density: 1.45 },
            HIPS: { name: 'High Impact Polystyrene', density: 1.04 },
            TPU: { name: 'Thermoplastic Polyurethane', density: 1.30 },
            CUSTOM: { name: 'Custom Material', density: 1.20 }
        };

        // Calculation functions
        function getCurrentDensity() {
            return state.filamentType === 'CUSTOM' ? state.customDensity : filamentTypes[state.filamentType].density;
        }

        function calculateVolume() {
            const radius = state.filamentDiameter / 2;
            return Math.PI * Math.pow(radius, 2) * state.filamentLength / 1000;
        }

        function calculateMaterialCost() {
            const density = getCurrentDensity();
            const volume = calculateVolume();
            const mass = (volume * density) / 1000;
            const pricePerKg = state.filamentPrice / state.filamentWeight;
            return mass * pricePerKg;
        }

        function calculatePowerCost() {
            const powerConsumptionKwh = (state.printerPower / 1000) * state.printTime;
            return powerConsumptionKwh * state.electricityRate;
        }

        function calculateMaintenanceCost() {
            return state.printTime * state.maintenanceCostPerHour;
        }

        function calculateLaborCost() {
            return state.printTime * state.hourlyRate;
        }

        function calculateOperationalCost() {
            return calculatePowerCost() + calculateMaintenanceCost();
        }

        function calculateSubtotal() {
            return calculateMaterialCost() + calculateLaborCost() + calculateOperationalCost();
        }

        function calculateFinalPrice() {
            const subtotal = calculateSubtotal();
            return subtotal * (1 + state.markup / 100);
        }

        function calculateProfit() {
            return calculateFinalPrice() - calculateSubtotal();
        }

        // Cost editing functions (removed)

        // Product functions
        async function saveProduct() {
            if (!state.productName.trim()) return;

            const productData = {
                id: state.editingProduct ? state.editingProduct.id : Date.now(),
                name: state.productName,
                filamentType: state.filamentType,
                customDensity: state.customDensity,
                filamentDiameter: state.filamentDiameter,
                filamentLength: state.filamentLength,
                filamentPrice: state.filamentPrice,
                filamentWeight: state.filamentWeight,
                printTime: state.printTime,
                hourlyRate: state.hourlyRate,
                markup: state.markup,
                printerPower: state.printerPower,
                electricityRate: state.electricityRate,
                maintenanceCostPerHour: state.maintenanceCostPerHour,
                materialCost: calculateMaterialCost(),
                laborCost: calculateLaborCost(),
                operationalCost: calculateOperationalCost(),
                finalPrice: calculateFinalPrice(),
                profit: calculateProfit(),
                createdAt: new Date().toISOString()
            };

            if (state.editingProduct) {
                state.products = state.products.map(p => p.id === state.editingProduct.id ? productData : p);
                state.editingProduct = null;
            } else {
                state.products.push(productData);
            }

            state.productName = '';
            saveToStorage();
            triggerAutoExport();
            await applyFilters();
        }

        function editProduct(product) {
            state.editingProduct = product;
            state.productName = product.name;
            state.filamentType = product.filamentType;
            state.customDensity = product.customDensity;
            state.filamentDiameter = product.filamentDiameter;
            state.filamentLength = product.filamentLength;
            state.filamentPrice = product.filamentPrice;
            state.filamentWeight = product.filamentWeight;
            state.printTime = product.printTime;
            state.hourlyRate = product.hourlyRate;
            state.markup = product.markup;
            state.printerPower = product.printerPower;
            state.electricityRate = product.electricityRate;
            state.maintenanceCostPerHour = product.maintenanceCostPerHour;
            state.showMobileMenu = false;
            render();
        }

        async function deleteProduct(id) {
            if (confirm('Are you sure you want to delete this product?')) {
                state.products = state.products.filter(p => p.id !== id);
                saveToStorage();
                triggerAutoExport();
                await applyFilters();
            }
        }

        async function duplicateProduct(product) {
            const duplicatedProduct = {
                ...product,
                id: Date.now(),
                name: product.name + ' (Copy)',
                createdAt: new Date().toISOString()
            };
            state.products.push(duplicatedProduct);
            saveToStorage();
            triggerAutoExport();
            await applyFilters();
        }

        function clearCalculator() {
            if (renderTimeout) {
                clearTimeout(renderTimeout);
            }
            state.editingProduct = null;
            state.productName = '';
            state.filamentType = 'PLA';
            state.customDensity = 1.20;
            state.filamentDiameter = 1.75;
            state.filamentLength = 1;
            state.filamentPrice = 450;
            state.filamentWeight = 1;
            state.printTime = 2;
            state.hourlyRate = 0;
            state.markup = 15;
            state.printerPower = 350;
            state.electricityRate = 3.50;
            state.maintenanceCostPerHour = 8.50;
            // resetAllCosts removed
        }

        // Database functions (PouchDB)
        let db = null;
        const DB_NAME = 'print_calculator';

        async function initDatabase() {
            try {
                db = new PouchDB(DB_NAME);
                console.log('PouchDB database initialized successfully');
                
                // Create indexes for better querying
                await createIndexes();
                
                return db;
            } catch (e) {
                console.error('PouchDB initialization failed:', e);
                throw e;
            }
        }

        async function createIndexes() {
            try {
                // Index for product name searches
                await db.createIndex({
                    index: { fields: ['name'] }
                });
                
                // Index for date-based queries
                await db.createIndex({
                    index: { fields: ['createdAt'] }
                });
                
                // Index for material type filtering
                await db.createIndex({
                    index: { fields: ['filamentType'] }
                });
                
                // Compound index for sorting by price
                await db.createIndex({
                    index: { fields: ['finalPrice', 'createdAt'] }
                });
                
                console.log('Database indexes created successfully');
            } catch (e) {
                console.error('Index creation error:', e);
            }
        }

        async function saveToDatabase() {
            if (!db) {
                console.error('Database not initialized');
                return;
            }
            
            try {
                // Get all existing docs to handle updates properly
                const existingDocs = await db.allDocs({ include_docs: true });
                const existingById = {};
                existingDocs.rows.forEach(row => {
                    if (row.doc && !row.doc._id.startsWith('_design/')) {
                        existingById[row.doc.productId] = row.doc;
                    }
                });
                
                // Prepare documents for bulk operations
                const docsToSave = [];
                const currentProductIds = new Set();
                
                for (const product of state.products) {
                    currentProductIds.add(product.id);
                    const existingDoc = existingById[product.id];
                    
                    const doc = {
                        _id: existingDoc ? existingDoc._id : `product_${product.id}`,
                        _rev: existingDoc ? existingDoc._rev : undefined,
                        productId: product.id,
                        type: 'product',
                        ...product
                    };
                    
                    docsToSave.push(doc);
                }
                
                // Add deleted docs
                Object.values(existingById).forEach(doc => {
                    if (!currentProductIds.has(doc.productId)) {
                        docsToSave.push({
                            ...doc,
                            _deleted: true
                        });
                    }
                });
                
                if (docsToSave.length > 0) {
                    await db.bulkDocs(docsToSave);
                }
                
                console.log('Products saved to PouchDB');
            } catch (e) {
                console.error('Database save error:', e);
            }
        }

        async function loadFromDatabase() {
            if (!db) {
                console.error('Database not initialized');
                return;
            }
            
            try {
                const result = await db.find({
                    selector: { type: 'product' },
                    sort: [{ 'createdAt': 'desc' }]
                });
                
                state.products = result.docs.map(doc => ({
                    id: doc.productId,
                    name: doc.name,
                    filamentType: doc.filamentType,
                    customDensity: doc.customDensity,
                    filamentDiameter: doc.filamentDiameter,
                    filamentLength: doc.filamentLength,
                    filamentPrice: doc.filamentPrice,
                    filamentWeight: doc.filamentWeight,
                    printTime: doc.printTime,
                    hourlyRate: doc.hourlyRate,
                    markup: doc.markup,
                    printerPower: doc.printerPower,
                    electricityRate: doc.electricityRate,
                    maintenanceCostPerHour: doc.maintenanceCostPerHour,
                    materialCost: doc.materialCost,
                    laborCost: doc.laborCost,
                    operationalCost: doc.operationalCost,
                    finalPrice: doc.finalPrice,
                    profit: doc.profit,
                    createdAt: doc.createdAt
                }));
                
                console.log(`Loaded ${state.products.length} products from PouchDB`);
                return state.products;
            } catch (e) {
                console.error('Database load error:', e);
                return [];
            }
        }

        async function migrateFromLocalStorage() {
            try {
                const saved = localStorage.getItem('3d_printing_products');
                if (saved) {
                    const products = JSON.parse(saved);
                    if (products.length > 0) {
                        console.log(`Migrating ${products.length} products from localStorage to PouchDB`);
                        state.products = products;
                        await saveToDatabase();
                        localStorage.removeItem('3d_printing_products');
                        console.log('Migration to PouchDB complete, localStorage cleared');
                    }
                }
            } catch (e) {
                console.log('Migration error:', e);
            }
        }

        async function migrateFromIndexedDB() {
            try {
                // Try to open the old IndexedDB
                const request = indexedDB.open('3DPrintCalculatorDB', 1);
                
                return new Promise((resolve) => {
                    request.onsuccess = async () => {
                        try {
                            const idb = request.result;
                            const transaction = idb.transaction(['products'], 'readonly');
                            const store = transaction.objectStore('products');
                            const getAll = store.getAll();
                            
                            getAll.onsuccess = async () => {
                                const products = getAll.result;
                                if (products && products.length > 0) {
                                    console.log(`Migrating ${products.length} products from IndexedDB to PouchDB`);
                                    state.products = products;
                                    await saveToDatabase();
                                    
                                    // Clean up old IndexedDB
                                    idb.close();
                                    indexedDB.deleteDatabase('3DPrintCalculatorDB');
                                    console.log('Migration from IndexedDB complete, old database removed');
                                }
                                resolve();
                            };
                            
                            getAll.onerror = () => resolve();
                        } catch (e) {
                            console.log('IndexedDB migration error:', e);
                            resolve();
                        }
                    };
                    
                    request.onerror = () => resolve();
                });
            } catch (e) {
                console.log('IndexedDB migration error:', e);
            }
        }

        // Advanced querying functions
        async function searchProducts(query) {
            if (!db || !query.trim()) {
                return state.products;
            }
            
            try {
                const result = await db.find({
                    selector: {
                        type: 'product',
                        name: { $regex: new RegExp(query.trim(), 'i') }
                    },
                    sort: [{ 'createdAt': 'desc' }]
                });
                
                return result.docs.map(doc => ({
                    id: doc.productId,
                    name: doc.name,
                    filamentType: doc.filamentType,
                    customDensity: doc.customDensity,
                    filamentDiameter: doc.filamentDiameter,
                    filamentLength: doc.filamentLength,
                    filamentPrice: doc.filamentPrice,
                    filamentWeight: doc.filamentWeight,
                    printTime: doc.printTime,
                    hourlyRate: doc.hourlyRate,
                    markup: doc.markup,
                    printerPower: doc.printerPower,
                    electricityRate: doc.electricityRate,
                    maintenanceCostPerHour: doc.maintenanceCostPerHour,
                    materialCost: doc.materialCost,
                    laborCost: doc.laborCost,
                    operationalCost: doc.operationalCost,
                    finalPrice: doc.finalPrice,
                    profit: doc.profit,
                    createdAt: doc.createdAt
                }));
            } catch (e) {
                console.error('Search error:', e);
                return state.products.filter(p => 
                    p.name.toLowerCase().includes(query.toLowerCase())
                );
            }
        }

        async function filterProductsByMaterial(materialType) {
            if (!db || !materialType) {
                return state.products;
            }
            
            try {
                const result = await db.find({
                    selector: {
                        type: 'product',
                        filamentType: materialType
                    },
                    sort: [{ 'createdAt': 'desc' }]
                });
                
                return result.docs.map(doc => ({
                    id: doc.productId,
                    name: doc.name,
                    filamentType: doc.filamentType,
                    customDensity: doc.customDensity,
                    filamentDiameter: doc.filamentDiameter,
                    filamentLength: doc.filamentLength,
                    filamentPrice: doc.filamentPrice,
                    filamentWeight: doc.filamentWeight,
                    printTime: doc.printTime,
                    hourlyRate: doc.hourlyRate,
                    markup: doc.markup,
                    printerPower: doc.printerPower,
                    electricityRate: doc.electricityRate,
                    maintenanceCostPerHour: doc.maintenanceCostPerHour,
                    materialCost: doc.materialCost,
                    laborCost: doc.laborCost,
                    operationalCost: doc.operationalCost,
                    finalPrice: doc.finalPrice,
                    profit: doc.profit,
                    createdAt: doc.createdAt
                }));
            } catch (e) {
                console.error('Filter error:', e);
                return state.products.filter(p => p.filamentType === materialType);
            }
        }

        async function sortProductsByPrice(ascending = false) {
            if (!db) {
                return state.products.sort((a, b) => 
                    ascending ? a.finalPrice - b.finalPrice : b.finalPrice - a.finalPrice
                );
            }
            
            try {
                const result = await db.find({
                    selector: { type: 'product' },
                    sort: ascending ? 
                        [{ 'finalPrice': 'asc' }] : 
                        [{ 'finalPrice': 'desc' }]
                });
                
                return result.docs.map(doc => ({
                    id: doc.productId,
                    name: doc.name,
                    filamentType: doc.filamentType,
                    customDensity: doc.customDensity,
                    filamentDiameter: doc.filamentDiameter,
                    filamentLength: doc.filamentLength,
                    filamentPrice: doc.filamentPrice,
                    filamentWeight: doc.filamentWeight,
                    printTime: doc.printTime,
                    hourlyRate: doc.hourlyRate,
                    markup: doc.markup,
                    printerPower: doc.printerPower,
                    electricityRate: doc.electricityRate,
                    maintenanceCostPerHour: doc.maintenanceCostPerHour,
                    materialCost: doc.materialCost,
                    laborCost: doc.laborCost,
                    operationalCost: doc.operationalCost,
                    finalPrice: doc.finalPrice,
                    profit: doc.profit,
                    createdAt: doc.createdAt
                }));
            } catch (e) {
                console.error('Sort error:', e);
                return state.products.sort((a, b) => 
                    ascending ? a.finalPrice - b.finalPrice : b.finalPrice - a.finalPrice
                );
            }
        }

        async function getProductStats() {
            if (!db) {
                return calculateStatsFromArray(state.products);
            }
            
            try {
                const result = await db.find({
                    selector: { type: 'product' }
                });
                
                return calculateStatsFromArray(result.docs);
            } catch (e) {
                console.error('Stats error:', e);
                return calculateStatsFromArray(state.products);
            }
        }

        function calculateStatsFromArray(products) {
            if (products.length === 0) {
                return {
                    totalProducts: 0,
                    totalRevenue: 0,
                    totalProfit: 0,
                    averagePrice: 0,
                    averageProfit: 0,
                    materialBreakdown: {}
                };
            }
            
            const totalRevenue = products.reduce((sum, p) => sum + (p.finalPrice || 0), 0);
            const totalProfit = products.reduce((sum, p) => sum + (p.profit || 0), 0);
            const materialBreakdown = {};
            
            products.forEach(p => {
                const material = p.filamentType || 'Unknown';
                if (!materialBreakdown[material]) {
                    materialBreakdown[material] = 0;
                }
                materialBreakdown[material]++;
            });
            
            return {
                totalProducts: products.length,
                totalRevenue,
                totalProfit,
                averagePrice: totalRevenue / products.length,
                averageProfit: totalProfit / products.length,
                materialBreakdown
            };
        }

        // CouchDB Sync functionality (optional)
        let syncHandler = null;
        
        async function setupSync(remoteUrl) {
            if (!db || !remoteUrl) {
                console.error('Database or remote URL not provided');
                return false;
            }
            
            try {
                // Stop existing sync if any
                if (syncHandler) {
                    syncHandler.cancel();
                }
                
                syncHandler = db.sync(remoteUrl, {
                    live: true,
                    retry: true
                }).on('change', (info) => {
                    console.log('Sync change:', info);
                    // Reload products when changes come from remote
                    if (info.direction === 'pull') {
                        loadFromDatabase().then(() => render());
                    }
                }).on('paused', () => {
                    console.log('Sync paused');
                }).on('active', () => {
                    console.log('Sync resumed');
                }).on('denied', (err) => {
                    console.error('Sync denied:', err);
                }).on('complete', (info) => {
                    console.log('Sync complete:', info);
                }).on('error', (err) => {
                    console.error('Sync error:', err);
                });
                
                console.log('Sync setup successful');
                return true;
            } catch (e) {
                console.error('Sync setup failed:', e);
                return false;
            }
        }
        
        function stopSync() {
            if (syncHandler) {
                syncHandler.cancel();
                syncHandler = null;
                console.log('Sync stopped');
            }
        }

        // Enhanced storage with multiple fallbacks
        function saveToStorage() {
            saveToDatabase().catch(e => {
                console.log('PouchDB save failed, using fallbacks');
                
                // Try multiple storage methods for redundancy
                try {
                    // Primary fallback: localStorage
                    localStorage.setItem('3d_printing_products', JSON.stringify(state.products));
                    localStorage.setItem('3d_printing_backup_timestamp', new Date().toISOString());
                    
                    // Secondary fallback: sessionStorage (temporary)
                    sessionStorage.setItem('3d_printing_products_session', JSON.stringify(state.products));
                    
                    // Tertiary fallback: export trigger for user download
                    if (state.products.length > 10) {
                        console.warn('Large dataset detected. Consider enabling cloud sync for better persistence.');
                    }
                } catch (err) {
                    console.error('All storage methods failed:', err);
                    // Show user warning about data persistence
                    showStorageWarning();
                }
            });
        }

        function loadFromStorage() {
            loadFromDatabase().catch(e => {
                console.log('PouchDB load failed, using fallbacks');
                try {
                    // Try localStorage first
                    const saved = localStorage.getItem('3d_printing_products');
                    if (saved) {
                        state.products = JSON.parse(saved);
                        console.log('Loaded from localStorage backup');
                        return;
                    }
                    
                    // Try sessionStorage as fallback
                    const sessionSaved = sessionStorage.getItem('3d_printing_products_session');
                    if (sessionSaved) {
                        state.products = JSON.parse(sessionSaved);
                        console.log('Loaded from sessionStorage backup');
                        // Immediately try to save to localStorage
                        localStorage.setItem('3d_printing_products', sessionSaved);
                    }
                } catch (err) {
                    console.error('Load error:', err);
                }
            });
        }

        function showStorageWarning() {
            // Only show once per session
            if (!sessionStorage.getItem('storage_warning_shown')) {
                setTimeout(() => {
                    if (confirm('Storage issue detected. Would you like to export your data as backup?')) {
                        exportProducts();
                    }
                    sessionStorage.setItem('storage_warning_shown', 'true');
                }, 1000);
            }
        }

        // Auto-backup functionality
        function setupAutoBackup() {
            // Export data automatically when products reach certain thresholds
            const productCount = state.products.length;
            const lastBackup = localStorage.getItem('last_auto_backup');
            const now = new Date().toISOString();
            
            // Auto-backup conditions
            const shouldBackup = (
                productCount >= 50 && (!lastBackup || 
                (new Date(now) - new Date(lastBackup)) > 7 * 24 * 60 * 60 * 1000) // 7 days
            );
            
            if (shouldBackup) {
                console.log('Triggering auto-backup...');
                localStorage.setItem('last_auto_backup', now);
                // Could trigger download or cloud sync here
            }
        }

        // Render function
        function render() {
            const app = document.getElementById('app');
            
            app.innerHTML = `
                <div class="max-w-7xl mx-auto p-2 md:p-6 bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
                    <!-- Notifications -->
                    ${state.notifications.length > 0 ? `
                        <div class="fixed top-4 right-4 z-50 space-y-2">
                            ${state.notifications.map(notification => `
                                <div class="bg-white border-l-4 ${
                                    notification.type === 'success' ? 'border-green-500' :
                                    notification.type === 'error' ? 'border-red-500' :
                                    notification.type === 'warning' ? 'border-yellow-500' :
                                    'border-blue-500'
                                } p-4 rounded-lg shadow-lg max-w-sm">
                                    <div class="flex justify-between items-start">
                                        <div class="text-sm font-medium text-gray-900">
                                            ${notification.message}
                                        </div>
                                        <button onclick="dismissNotification(${notification.id})" class="ml-2 text-gray-400 hover:text-gray-600">
                                            ‚úï
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    ${state.showInstallButton ? `
                        <div class="bg-blue-600 text-white p-4 rounded-lg mb-4 flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <span>üì±</span>
                                <div>
                                    <h3 class="font-semibold">Install App</h3>
                                    <p class="text-sm opacity-90">Add to home screen for quick access</p>
                                </div>
                            </div>
                            <button onclick="installApp()" class="bg-white text-blue-600 px-4 py-2 rounded-lg font-medium hover:bg-gray-100">
                                Install
                            </button>
                        </div>
                    ` : ''}

                    <!-- Header -->
                    <div class="mb-6 text-center">
                        <h1 class="text-2xl md:text-4xl font-bold text-gray-800 mb-2 flex items-center justify-center gap-3">
                            üßÆ 3D Print Calculator
                        </h1>
                        <p class="text-gray-600 text-sm md:text-base">Calculate costs and manage your 3D printing business</p>
                    </div>

                    <!-- Mobile Layout -->
                    <div class="block lg:hidden">
                        <!-- Mobile Navigation -->
                        <div class="bg-white rounded-lg shadow-lg mb-4">
                            <div class="flex border-b">
                                <button onclick="toggleMobileMenu(false)" class="flex-1 py-3 px-4 text-center font-medium ${!state.showMobileMenu ? 'bg-blue-600 text-white' : 'text-gray-600'}">
                                    Calculator
                                </button>
                                <button onclick="toggleMobileMenu(true)" class="flex-1 py-3 px-4 text-center font-medium ${state.showMobileMenu ? 'bg-blue-600 text-white' : 'text-gray-600'}">
                                    Products (${state.products.length})
                                </button>
                            </div>
                        </div>

                        ${!state.showMobileMenu ? renderMobileCalculator() : renderMobileProducts()}
                    </div>

                    <!-- Desktop Layout -->
                    <div class="hidden lg:block">
                        <div class="grid lg:grid-cols-2 gap-6">
                            ${renderDesktopCalculator()}
                            ${renderDesktopResults()}
                        </div>
                        ${renderDesktopProducts()}
                    </div>
                </div>
            `;
        }

        // renderCostValue function removed

        function renderMobileCalculator() {
            return `
                <div class="space-y-4">
                    <!-- Cost Breakdown -->
                    <div class="bg-white rounded-lg shadow-lg p-4">
                        <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2 mb-4">
                            üí∞ Cost Breakdown
                        </h2>

                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div class="bg-blue-50 rounded-lg p-3">
                                <h3 class="font-semibold text-blue-800 mb-1">Material</h3>
                                <div class="text-lg font-bold">R${calculateMaterialCost().toFixed(2)}</div>
                            </div>

                            <div class="bg-green-50 rounded-lg p-3">
                                <h3 class="font-semibold text-green-800 mb-1">Labour</h3>
                                <div class="text-lg font-bold">R${calculateLaborCost().toFixed(2)}</div>
                            </div>

                            <div class="bg-yellow-50 rounded-lg p-3">
                                <h3 class="font-semibold text-yellow-800 mb-1">Operational</h3>
                                <div class="text-lg font-bold">R${calculateOperationalCost().toFixed(2)}</div>
                            </div>

                            <div class="bg-purple-50 rounded-lg p-3">
                                <h3 class="font-semibold text-purple-800 mb-1">Profit</h3>
                                <div class="text-lg font-bold">R${calculateProfit().toFixed(2)}</div>
                            </div>
                        </div>

                        <div class="bg-indigo-100 rounded-lg p-4 mt-4 border-2 border-indigo-300">
                            <h3 class="font-semibold text-indigo-800 mb-2">Final Selling Price</h3>
                            <div class="text-2xl font-bold">R${calculateFinalPrice().toFixed(2)}</div>
                        </div>
                    </div>

                    <!-- Settings -->
                    <div class="bg-white rounded-lg shadow-lg p-4">
                        <h2 class="text-xl font-semibold mb-4 text-gray-800 flex items-center gap-2">
                            ‚öôÔ∏è ${state.editingProduct ? `Editing: ${state.editingProduct.name}` : 'Settings'}
                        </h2>

                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Product Name</label>
                                <input 
                                    id="mobile-product-name"
                                    type="text" 
                                    value="${state.productName}" 
                                    oninput="updateState('productName', this.value)"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 ${state.editingProduct ? 'bg-blue-50 border-blue-300' : ''}"
                                    placeholder="Enter product name"
                                />
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Material</label>
                                <select onchange="updateStateImmediate('filamentType', this.value)" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                                    ${Object.keys(filamentTypes).map(key => 
                                        `<option value="${key}" ${state.filamentType === key ? 'selected' : ''}>${key}</option>`
                                    ).join('')}
                                </select>
                            </div>

                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Length (m)</label>
                                    <input 
                                        id="mobile-length"
                                        type="text" 
                                        inputmode="decimal"
                                        value="${state.filamentLength}" 
                                        oninput="updateStateNumber('filamentLength', this.value)"
                                        class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                                        placeholder="0.0"
                                    />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Time (hours)</label>
                                    <input 
                                        id="mobile-time"
                                        type="text" 
                                        inputmode="decimal"
                                        value="${state.printTime}" 
                                        oninput="updateStateNumber('printTime', this.value)"
                                        class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                                        placeholder="0.0"
                                    />
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Price (R)</label>
                                    <input 
                                        id="mobile-price"
                                        type="text" 
                                        inputmode="decimal"
                                        value="${state.filamentPrice}" 
                                        oninput="updateStateNumber('filamentPrice', this.value)"
                                        class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                                        placeholder="0.00"
                                    />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Rate (R/h)</label>
                                    <input 
                                        id="mobile-rate"
                                        type="text" 
                                        inputmode="decimal"
                                        value="${state.hourlyRate}" 
                                        oninput="updateStateNumber('hourlyRate', this.value)"
                                        class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                                        placeholder="0.00"
                                    />
                                </div>
                            </div>
                        </div>

                        <div class="flex gap-3 mt-4">
                            <button 
                                onclick="saveProduct()" 
                                ${!state.productName.trim() ? 'disabled' : ''}
                                class="flex-1 bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 disabled:opacity-50 font-medium"
                            >
                                üíæ ${state.editingProduct ? 'Update' : 'Save'}
                            </button>
                            <button onclick="clearCalculator()" class="bg-gray-500 text-white py-3 px-4 rounded-lg hover:bg-gray-600">
                                Clear
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMobileProducts() {
            const displayProducts = state.filteredProducts.length > 0 ? state.filteredProducts : state.products;
            
            return `
                <div class="bg-white rounded-lg shadow-lg p-4">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">Products (${displayProducts.length})</h2>
                        <div class="flex gap-2">
                            <button onclick="importProducts()" class="text-green-600 hover:text-green-800 text-sm">
                                üì§ Import
                            </button>
                            <button onclick="exportProducts()" class="text-blue-600 hover:text-blue-800 text-sm">
                                üì• Export
                            </button>
                            <button onclick="toggleAutoExport()" class="text-${state.autoExportEnabled ? 'orange' : 'gray'}-600 hover:text-${state.autoExportEnabled ? 'orange' : 'gray'}-800 text-sm" title="${state.autoExportEnabled ? 'Auto-export ON' : 'Auto-export OFF'}">
                                ${state.autoExportEnabled ? 'üîÑ' : '‚è∏Ô∏è'} Auto
                            </button>
                            ${state.products.length === 0 ? `
                                <button onclick="loadSampleData()" class="text-purple-600 hover:text-purple-800 text-sm">
                                    ‚ú® Samples
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- Search and Filter -->
                    <div class="space-y-3 mb-4">
                        <div>
                            <input 
                                id="mobile-search"
                                type="text" 
                                placeholder="Search products..." 
                                value="${state.searchQuery}"
                                oninput="updateSearch(this.value)"
                                class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                            />
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <select onchange="updateMaterialFilter(this.value)" class="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">All Materials</option>
                                ${Object.keys(filamentTypes).map(key => 
                                    `<option value="${key}" ${state.selectedMaterial === key ? 'selected' : ''}>${key}</option>`
                                ).join('')}
                            </select>
                            
                            <select onchange="updateSortOrder(this.value)" class="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="date_desc" ${state.sortOrder === 'date_desc' ? 'selected' : ''}>Newest First</option>
                                <option value="date_asc" ${state.sortOrder === 'date_asc' ? 'selected' : ''}>Oldest First</option>
                                <option value="price_desc" ${state.sortOrder === 'price_desc' ? 'selected' : ''}>Price High-Low</option>
                                <option value="price_asc" ${state.sortOrder === 'price_asc' ? 'selected' : ''}>Price Low-High</option>
                            </select>
                        </div>
                        
                        ${(state.searchQuery || state.selectedMaterial) ? `
                            <button onclick="clearFilters()" class="text-sm text-gray-600 hover:text-gray-800">
                                Clear Filters
                            </button>
                        ` : ''}
                    </div>
                    
                    ${displayProducts.length === 0 ? `
                        <p class="text-gray-500 text-center py-8">
                            ${state.products.length === 0 ? 'No products saved yet' : 'No products match your filters'}
                        </p>
                    ` : `
                        <div class="space-y-3">
                            ${displayProducts.map(product => `
                                <div class="border border-gray-200 rounded-lg p-3">
                                    <div class="flex justify-between items-start mb-2">
                                        <h3 class="font-semibold text-gray-800">${product.name}</h3>
                                        <div class="flex gap-2">
                                            <button onclick="editProduct(${JSON.stringify(product).replace(/"/g, '&quot;')})" class="text-blue-600 hover:text-blue-800 p-1">
                                                ‚úèÔ∏è
                                            </button>
                                            <button onclick="deleteProduct(${product.id})" class="text-red-600 hover:text-red-800 p-1">
                                                üóëÔ∏è
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-2 text-sm">
                                        <div>
                                            <span class="text-gray-600">Material:</span>
                                            <span class="ml-2 font-medium">${product.filamentType}</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-600">Time:</span>
                                            <span class="ml-2 font-medium">${product.printTime}h</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-600">Cost:</span>
                                            <span class="ml-2 font-medium">R${(product.materialCost + product.laborCost + product.operationalCost).toFixed(2)}</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-600">Price:</span>
                                            <span class="ml-2 font-bold text-green-600">R${product.finalPrice.toFixed(2)}</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
            `;
        }

        function renderDesktopCalculator() {
            return `
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-semibold mb-6 text-gray-800 flex items-center gap-2">
                        ‚öôÔ∏è ${state.editingProduct ? `Editing: ${state.editingProduct.name}` : 'Calculator Settings'}
                    </h2>

                    <div class="space-y-6">
                        <!-- Product Name -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Product Name</label>
                            <input 
                                id="desktop-product-name"
                                type="text" 
                                value="${state.productName}" 
                                oninput="updateState('productName', this.value)"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 ${state.editingProduct ? 'bg-blue-50 border-blue-300' : ''}"
                                placeholder="Enter product name for saving"
                            />
                        </div>

                        <!-- Material Settings -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h3 class="text-lg font-medium text-gray-800 mb-4 flex items-center gap-2">
                                üé® Material Settings
                            </h3>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Filament Type</label>
                                    <select onchange="updateStateImmediate('filamentType', this.value)" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                        ${Object.keys(filamentTypes).map(key => 
                                            `<option value="${key}" ${state.filamentType === key ? 'selected' : ''}>${key} - ${filamentTypes[key].name}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                
                                ${state.filamentType === 'CUSTOM' ? `
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Custom Density (g/cm¬≥)</label>
                                        <input 
                                            type="text" 
                                            inputmode="decimal"
                                            value="${state.customDensity}" 
                                            oninput="updateStateNumber('customDensity', this.value)"
                                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                            placeholder="1.20"
                                        />
                                    </div>
                                ` : `
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Density (g/cm¬≥)</label>
                                        <input 
                                            type="text" 
                                            value="${getCurrentDensity()}" 
                                            disabled
                                            class="w-full p-2 border border-gray-300 rounded-lg bg-gray-100"
                                        />
                                    </div>
                                `}

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Filament Diameter (mm)</label>
                                    <input 
                                        type="text" 
                                        inputmode="decimal"
                                        value="${state.filamentDiameter}" 
                                        oninput="updateStateNumber('filamentDiameter', this.value)"
                                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        placeholder="1.75"
                                    />
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Filament Length (m)</label>
                                    <input 
                                        id="desktop-length"
                                        type="text" 
                                        inputmode="decimal"
                                        value="${state.filamentLength}" 
                                        oninput="updateStateNumber('filamentLength', this.value)"
                                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        placeholder="0.0"
                                    />
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Filament Price (R)</label>
                                    <input 
                                        type="text" 
                                        inputmode="decimal"
                                        value="${state.filamentPrice}" 
                                        oninput="updateStateNumber('filamentPrice', this.value)"
                                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        placeholder="450"
                                    />
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Filament Weight (kg)</label>
                                    <input 
                                        type="text" 
                                        inputmode="decimal"
                                        value="${state.filamentWeight}" 
                                        oninput="updateStateNumber('filamentWeight', this.value)"
                                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        placeholder="1.0"
                                    />
                                </div>
                            </div>
                        </div>

                        <!-- Production Settings -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h3 class="text-lg font-medium text-gray-800 mb-4 flex items-center gap-2">
                                ‚è±Ô∏è Production Settings
                            </h3>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Print Time (hours)</label>
                                    <input 
                                        id="desktop-time"
                                        type="text" 
                                        inputmode="decimal"
                                        value="${state.printTime}" 
                                        oninput="updateStateNumber('printTime', this.value)"
                                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        placeholder="2.0"
                                    />
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Hourly Rate (R/hour)</label>
                                    <input 
                                        id="desktop-rate"
                                        type="text" 
                                        inputmode="decimal"
                                        value="${state.hourlyRate}" 
                                        oninput="updateStateNumber('hourlyRate', this.value)"
                                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        placeholder="50"
                                    />
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Markup (%)</label>
                                    <input 
                                        type="text" 
                                        inputmode="decimal"
                                        value="${state.markup}" 
                                        oninput="updateStateNumber('markup', this.value)"
                                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        placeholder="15"
                                    />
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Printer Power (W)</label>
                                    <input 
                                        type="text" 
                                        inputmode="decimal"
                                        value="${state.printerPower}" 
                                        oninput="updateStateNumber('printerPower', this.value)"
                                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        placeholder="350"
                                    />
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Electricity Rate (R/kWh)</label>
                                    <input 
                                        type="text" 
                                        inputmode="decimal"
                                        value="${state.electricityRate}" 
                                        oninput="updateStateNumber('electricityRate', this.value)"
                                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        placeholder="3.50"
                                    />
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Maintenance (R/hour)</label>
                                    <input 
                                        type="text" 
                                        inputmode="decimal"
                                        value="${state.maintenanceCostPerHour}" 
                                        oninput="updateStateNumber('maintenanceCostPerHour', this.value)"
                                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        placeholder="8.50"
                                    />
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex gap-3">
                            <button 
                                onclick="saveProduct()" 
                                ${!state.productName.trim() ? 'disabled' : ''}
                                class="flex-1 bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 disabled:opacity-50 font-medium transition-colors"
                            >
                                üíæ ${state.editingProduct ? 'Update Product' : 'Save Product'}
                            </button>
                            <button onclick="clearCalculator()" class="bg-gray-500 text-white py-3 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                                üîÑ Clear
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDesktopResults() {
            return `
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-semibold mb-6 text-gray-800 flex items-center gap-2">
                        üí∞ Cost Breakdown
                    </h2>

                    <div class="space-y-6">
                        <!-- Summary Cards -->
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-lg p-4">
                                <h3 class="text-lg font-medium mb-2">Material Cost</h3>
                                <div class="text-2xl font-bold">R${calculateMaterialCost().toFixed(2)}</div>
                                <p class="text-sm mt-2 opacity-90">
                                    ${(calculateVolume() * getCurrentDensity() / 1000).toFixed(3)} kg used
                                </p>
                            </div>

                            <div class="bg-gradient-to-br from-green-500 to-green-600 text-white rounded-lg p-4">
                                <h3 class="text-lg font-medium mb-2">Labour Cost</h3>
                                <div class="text-2xl font-bold">R${calculateLaborCost().toFixed(2)}</div>
                                <p class="text-sm mt-2 opacity-90">
                                    ${state.printTime} hours @ R${state.hourlyRate}/hr
                                </p>
                            </div>

                            <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 text-white rounded-lg p-4">
                                <h3 class="text-lg font-medium mb-2">Operational Cost</h3>
                                <div class="text-2xl font-bold">R${calculateOperationalCost().toFixed(2)}</div>
                                <p class="text-sm mt-2 opacity-90">
                                    Power: R${calculatePowerCost().toFixed(2)} | Maint: R${calculateMaintenanceCost().toFixed(2)}
                                </p>
                            </div>

                            <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-lg p-4">
                                <h3 class="text-lg font-medium mb-2">Profit (${state.markup}%)</h3>
                                <div class="text-2xl font-bold">R${calculateProfit().toFixed(2)}</div>
                                <p class="text-sm mt-2 opacity-90">
                                    Markup on subtotal
                                </p>
                            </div>
                        </div>

                        <!-- Detailed Breakdown -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h3 class="text-lg font-medium text-gray-800 mb-3">Detailed Breakdown</h3>
                            
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between py-2 border-b border-gray-200">
                                    <span class="text-gray-600">Material Volume</span>
                                    <span class="font-medium">${calculateVolume().toFixed(2)} cm¬≥</span>
                                </div>
                                <div class="flex justify-between py-2 border-b border-gray-200">
                                    <span class="text-gray-600">Material Weight</span>
                                    <span class="font-medium">${(calculateVolume() * getCurrentDensity() / 1000).toFixed(3)} kg</span>
                                </div>
                                <div class="flex justify-between py-2 border-b border-gray-200">
                                    <span class="text-gray-600">Price per kg</span>
                                    <span class="font-medium">R${(state.filamentPrice / state.filamentWeight).toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between py-2 border-b border-gray-200">
                                    <span class="text-gray-600">Power Consumption</span>
                                    <span class="font-medium">${((state.printerPower / 1000) * state.printTime).toFixed(2)} kWh</span>
                                </div>
                                <div class="flex justify-between py-2 border-b border-gray-200">
                                    <span class="text-gray-600">Subtotal (before markup)</span>
                                    <span class="font-semibold">R${calculateSubtotal().toFixed(2)}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Final Price -->
                        <div class="bg-gradient-to-br from-indigo-600 to-indigo-700 text-white rounded-lg p-6">
                            <h3 class="text-xl font-semibold mb-3">Final Selling Price</h3>
                            <div class="text-3xl font-bold">R${calculateFinalPrice().toFixed(2)}</div>
                            
                            <div class="mt-4 pt-4 border-t border-white border-opacity-30">
                                <div class="flex justify-between text-sm">
                                    <span>Cost</span>
                                    <span>R${calculateSubtotal().toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between text-sm mt-1">
                                    <span>Profit</span>
                                    <span>R${calculateProfit().toFixed(2)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDesktopProducts() {
            if (state.products.length === 0) return '';
            
            const displayProducts = state.filteredProducts.length > 0 ? state.filteredProducts : state.products;
            
            return `
                <div class="bg-white rounded-xl shadow-lg p-6 mt-6 lg:col-span-2">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold text-gray-800 flex items-center gap-2">
                            üì¶ Saved Products (${displayProducts.length}${state.products.length !== displayProducts.length ? ` of ${state.products.length}` : ''})
                        </h2>
                        <div class="flex gap-3">
                            <button onclick="importProducts()" class="text-green-600 hover:text-green-800 font-medium">
                                üì§ Import
                            </button>
                            <button onclick="exportProducts()" class="text-blue-600 hover:text-blue-800 font-medium">
                                üì• Export
                            </button>
                            <button onclick="toggleAutoExport()" class="text-${state.autoExportEnabled ? 'orange' : 'gray'}-600 hover:text-${state.autoExportEnabled ? 'orange' : 'gray'}-800 font-medium" title="${state.autoExportEnabled ? 'Auto-export enabled - files auto-download' : 'Auto-export disabled - manual export only'}">
                                ${state.autoExportEnabled ? 'üîÑ Auto-Export ON' : '‚è∏Ô∏è Auto-Export OFF'}
                            </button>
                            ${state.products.length === 0 ? `
                                <button onclick="loadSampleData()" class="text-purple-600 hover:text-purple-800 font-medium">
                                    ‚ú® Load Samples
                                </button>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Search and Filter Controls -->
                    <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div class="md:col-span-2">
                                <input 
                                    id="desktop-search"
                                    type="text" 
                                    placeholder="Search products..." 
                                    value="${state.searchQuery}"
                                    oninput="updateSearch(this.value)"
                                    class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                />
                            </div>
                            
                            <div>
                                <select onchange="updateMaterialFilter(this.value)" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">All Materials</option>
                                    ${Object.keys(filamentTypes).map(key => 
                                        `<option value="${key}" ${state.selectedMaterial === key ? 'selected' : ''}>${key}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            
                            <div>
                                <select onchange="updateSortOrder(this.value)" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="date_desc" ${state.sortOrder === 'date_desc' ? 'selected' : ''}>Newest First</option>
                                    <option value="date_asc" ${state.sortOrder === 'date_asc' ? 'selected' : ''}>Oldest First</option>
                                    <option value="price_desc" ${state.sortOrder === 'price_desc' ? 'selected' : ''}>Price High-Low</option>
                                    <option value="price_asc" ${state.sortOrder === 'price_asc' ? 'selected' : ''}>Price Low-High</option>
                                </select>
                            </div>
                        </div>
                        
                        ${(state.searchQuery || state.selectedMaterial) ? `
                            <div class="mt-4">
                                <button onclick="clearFilters()" class="text-sm text-gray-600 hover:text-gray-800 bg-white px-3 py-1 rounded border">
                                    Clear Filters
                                </button>
                            </div>
                        ` : ''}
                    </div>

                    ${displayProducts.length === 0 ? `
                        <div class="text-center py-12">
                            <p class="text-gray-500 text-lg">
                                ${state.products.length === 0 ? 'No products saved yet' : 'No products match your filters'}
                            </p>
                        </div>
                    ` : `
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b-2 border-gray-200">
                                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Product Name</th>
                                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Material</th>
                                        <th class="text-right py-3 px-4 font-semibold text-gray-700">Length</th>
                                        <th class="text-right py-3 px-4 font-semibold text-gray-700">Time</th>
                                        <th class="text-right py-3 px-4 font-semibold text-gray-700">Material Cost</th>
                                        <th class="text-right py-3 px-4 font-semibold text-gray-700">Labour Cost</th>
                                        <th class="text-right py-3 px-4 font-semibold text-gray-700">Operational</th>
                                        <th class="text-right py-3 px-4 font-semibold text-gray-700">Total Cost</th>
                                        <th class="text-right py-3 px-4 font-semibold text-gray-700">Selling Price</th>
                                        <th class="text-right py-3 px-4 font-semibold text-gray-700">Profit</th>
                                        <th class="text-center py-3 px-4 font-semibold text-gray-700">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${displayProducts.map((product, index) => `
                                        <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors ${state.editingProduct && state.editingProduct.id === product.id ? 'bg-blue-50' : ''}">
                                            <td class="py-3 px-4">
                                                <div class="font-medium text-gray-900">${product.name}</div>
                                                <div class="text-xs text-gray-500">${new Date(product.createdAt).toLocaleDateString()}</div>
                                            </td>
                                            <td class="py-3 px-4 text-gray-700">${product.filamentType}</td>
                                            <td class="py-3 px-4 text-right text-gray-700">${product.filamentLength}m</td>
                                            <td class="py-3 px-4 text-right text-gray-700">${product.printTime}h</td>
                                            <td class="py-3 px-4 text-right text-gray-700">R${product.materialCost.toFixed(2)}</td>
                                            <td class="py-3 px-4 text-right text-gray-700">R${product.laborCost.toFixed(2)}</td>
                                            <td class="py-3 px-4 text-right text-gray-700">R${product.operationalCost.toFixed(2)}</td>
                                            <td class="py-3 px-4 text-right font-medium text-gray-900">
                                                R${(product.materialCost + product.laborCost + product.operationalCost).toFixed(2)}
                                            </td>
                                            <td class="py-3 px-4 text-right font-bold text-green-600">
                                                R${product.finalPrice.toFixed(2)}
                                            </td>
                                            <td class="py-3 px-4 text-right font-medium text-purple-600">
                                                R${product.profit.toFixed(2)}
                                            </td>
                                            <td class="py-3 px-4">
                                                <div class="flex justify-center gap-2">
                                                    <button 
                                                        onclick="editProduct(${JSON.stringify(product).replace(/"/g, '&quot;')})" 
                                                        class="text-blue-600 hover:text-blue-800 p-1"
                                                        title="Edit"
                                                    >
                                                        ‚úèÔ∏è
                                                    </button>
                                                    <button 
                                                        onclick="duplicateProduct(${JSON.stringify(product).replace(/"/g, '&quot;')})" 
                                                        class="text-green-600 hover:text-green-800 p-1"
                                                        title="Duplicate"
                                                    >
                                                        üìã
                                                    </button>
                                                    <button 
                                                        onclick="deleteProduct(${product.id})" 
                                                        class="text-red-600 hover:text-red-800 p-1"
                                                        title="Delete"
                                                    >
                                                        üóëÔ∏è
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                                <tfoot>
                                    <tr class="border-t-2 border-gray-200 font-semibold">
                                        <td colspan="4" class="py-3 px-4 text-gray-700">
                                            Totals ${displayProducts.length !== state.products.length ? `(Filtered: ${displayProducts.length} items)` : `(${displayProducts.length} items)`}
                                        </td>
                                        <td class="py-3 px-4 text-right text-gray-700">
                                            R${displayProducts.reduce((sum, p) => sum + p.materialCost, 0).toFixed(2)}
                                        </td>
                                        <td class="py-3 px-4 text-right text-gray-700">
                                            R${displayProducts.reduce((sum, p) => sum + p.laborCost, 0).toFixed(2)}
                                        </td>
                                        <td class="py-3 px-4 text-right text-gray-700">
                                            R${displayProducts.reduce((sum, p) => sum + p.operationalCost, 0).toFixed(2)}
                                        </td>
                                        <td class="py-3 px-4 text-right text-gray-900">
                                            R${displayProducts.reduce((sum, p) => sum + p.materialCost + p.laborCost + p.operationalCost, 0).toFixed(2)}
                                        </td>
                                        <td class="py-3 px-4 text-right text-green-600">
                                            R${displayProducts.reduce((sum, p) => sum + p.finalPrice, 0).toFixed(2)}
                                        </td>
                                        <td class="py-3 px-4 text-right text-purple-600">
                                            R${displayProducts.reduce((sum, p) => sum + p.profit, 0).toFixed(2)}
                                        </td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    `}
                </div>
            `;
        }

        // Event handlers
        let renderTimeout = null;
        let lastFocusedId = null;
        let lastCursorPosition = null;
        
        function updateState(key, value) {
            state[key] = value;
            
            // Store the currently focused element ID and cursor position
            const activeElement = document.activeElement;
            if (activeElement && activeElement.id) {
                lastFocusedId = activeElement.id;
                if (activeElement.selectionStart !== undefined) {
                    lastCursorPosition = {
                        start: activeElement.selectionStart,
                        end: activeElement.selectionEnd
                    };
                }
            }
            
            // Debounce rendering to prevent focus loss
            if (renderTimeout) {
                clearTimeout(renderTimeout);
            }
            renderTimeout = setTimeout(() => {
                render();
                restoreFocus();
            }, 300);
        }
        
        // Immediate update for non-input changes
        function updateStateImmediate(key, value) {
            state[key] = value;
            render();
        }

        // Number input handler with flexible parsing
        function updateStateNumber(key, value) {
            // Store focus info before updating state
            const activeElement = document.activeElement;
            if (activeElement && activeElement.id) {
                lastFocusedId = activeElement.id;
                if (activeElement.selectionStart !== undefined) {
                    lastCursorPosition = {
                        start: activeElement.selectionStart,
                        end: activeElement.selectionEnd
                    };
                }
            }

            // Clean and parse the value
            let cleanValue = value;
            
            // Remove any non-numeric characters except decimal point, minus, and common separators
            cleanValue = cleanValue.replace(/[^\d.,-]/g, '');
            
            // Handle common decimal separators (comma to dot)
            cleanValue = cleanValue.replace(',', '.');
            
            // Handle multiple decimal points (keep only the first one)
            const parts = cleanValue.split('.');
            if (parts.length > 2) {
                cleanValue = parts[0] + '.' + parts.slice(1).join('');
            }
            
            // Parse to number, fallback to 0 for empty or invalid values
            const numericValue = cleanValue === '' || cleanValue === '.' || cleanValue === '-' ? 
                0 : (parseFloat(cleanValue) || 0);
            
            // Ensure non-negative for most fields (except hourlyRate which can be 0)
            const finalValue = numericValue < 0 ? 0 : numericValue;
            
            state[key] = finalValue;
            
            // Debounce rendering
            if (renderTimeout) {
                clearTimeout(renderTimeout);
            }
            renderTimeout = setTimeout(() => {
                render();
                restoreFocus();
            }, 300);
        }
        
        // Restore focus to the previously active element
        function restoreFocus() {
            if (lastFocusedId) {
                try {
                    const element = document.getElementById(lastFocusedId);
                    if (element) {
                        element.focus();
                        // Restore cursor position for text inputs
                        if (lastCursorPosition && element.setSelectionRange) {
                            element.setSelectionRange(lastCursorPosition.start, lastCursorPosition.end);
                        }
                    }
                } catch (e) {
                    // Ignore focus restoration errors
                }
                lastFocusedId = null;
                lastCursorPosition = null;
            }
        }

        function toggleMobileMenu(show) {
            state.showMobileMenu = show;
            render();
        }

        async function updateSearch(query) {
            // Store focus info before updating state
            const activeElement = document.activeElement;
            if (activeElement && activeElement.id) {
                lastFocusedId = activeElement.id;
                if (activeElement.selectionStart !== undefined) {
                    lastCursorPosition = {
                        start: activeElement.selectionStart,
                        end: activeElement.selectionEnd
                    };
                }
            }
            
            state.searchQuery = query;
            await applyFilters();
            
            // Restore focus after the async operation
            setTimeout(() => restoreFocus(), 10);
        }

        async function updateMaterialFilter(material) {
            state.selectedMaterial = material;
            await applyFilters();
        }

        async function updateSortOrder(order) {
            state.sortOrder = order;
            await applyFilters();
        }

        async function applyFilters() {
            let products = state.products;

            // Apply search filter
            if (state.searchQuery.trim()) {
                products = await searchProducts(state.searchQuery);
            }

            // Apply material filter
            if (state.selectedMaterial) {
                products = products.filter(p => p.filamentType === state.selectedMaterial);
            }

            // Apply sorting
            switch (state.sortOrder) {
                case 'date_asc':
                    products.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                    break;
                case 'date_desc':
                    products.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    break;
                case 'price_asc':
                    products.sort((a, b) => a.finalPrice - b.finalPrice);
                    break;
                case 'price_desc':
                    products.sort((a, b) => b.finalPrice - a.finalPrice);
                    break;
            }

            state.filteredProducts = products;
            render();
        }

        function clearFilters() {
            state.searchQuery = '';
            state.selectedMaterial = '';
            state.sortOrder = 'date_desc';
            state.filteredProducts = state.products;
            render();
        }

        function exportProducts(isAutoExport = false) {
            const timestamp = new Date().toISOString();
            const dateStr = timestamp.split('T')[0];
            const timeStr = timestamp.split('T')[1].substring(0, 8).replace(/:/g, '-');
            
            const prefix = isAutoExport ? 'auto-backup' : '3d-print-products';
            const exportFileDefaultName = `${prefix}-${dateStr}-${timeStr}.json`;
            
            const exportData = {
                metadata: {
                    exportDate: timestamp,
                    version: "2.0.0",
                    productCount: state.products.length,
                    autoExport: isAutoExport
                },
                products: state.products
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.style.display = 'none';
            document.body.appendChild(linkElement);
            linkElement.click();
            document.body.removeChild(linkElement);
            
            if (isAutoExport) {
                state.lastAutoExport = timestamp;
                console.log(`Auto-exported ${state.products.length} products to ${exportFileDefaultName}`);
                showNotification(`üìÅ Auto-exported ${state.products.length} products`, 'success');
            }
        }

        // Auto-export functionality
        let changesSinceLastExport = 0;

        function triggerAutoExport() {
            if (!state.autoExportEnabled) return;
            
            changesSinceLastExport++;
            
            // Auto-export conditions
            const shouldAutoExport = (
                changesSinceLastExport >= state.autoExportThreshold ||
                (state.products.length > 0 && state.products.length % 10 === 0) // Every 10 products
            );
            
            if (shouldAutoExport) {
                setTimeout(() => {
                    exportProducts(true);
                    changesSinceLastExport = 0;
                }, 1000); // Delay to ensure all operations complete
            }
        }

        function toggleAutoExport() {
            state.autoExportEnabled = !state.autoExportEnabled;
            
            // Save preference to localStorage
            try {
                localStorage.setItem('autoExportEnabled', state.autoExportEnabled.toString());
            } catch (e) {
                console.warn('Could not save auto-export preference');
            }
            
            render();
            
            if (state.autoExportEnabled) {
                console.log('Auto-export enabled. Will export after every 5 changes or every 10 products.');
                showNotification('üîÑ Auto-export enabled', 'info');
            } else {
                console.log('Auto-export disabled.');
                showNotification('‚è∏Ô∏è Auto-export disabled', 'info');
            }
        }

        // Notification system
        function showNotification(message, type = 'info', duration = 3000) {
            const notification = {
                id: Date.now(),
                message,
                type, // 'success', 'error', 'warning', 'info'
                timestamp: new Date().toISOString()
            };
            
            state.notifications.push(notification);
            render();
            
            // Auto-remove notification after duration
            setTimeout(() => {
                state.notifications = state.notifications.filter(n => n.id !== notification.id);
                render();
            }, duration);
        }

        function dismissNotification(id) {
            state.notifications = state.notifications.filter(n => n.id !== id);
            render();
        }

        // Import products from JSON file
        function importProducts() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const importedData = JSON.parse(text);
                    
                    // Handle both old format (array) and new format (object with metadata)
                    let importedProducts;
                    if (Array.isArray(importedData)) {
                        // Old format - direct array of products
                        importedProducts = importedData;
                    } else if (importedData.products && Array.isArray(importedData.products)) {
                        // New format - object with metadata and products array
                        importedProducts = importedData.products;
                        console.log('Import metadata:', importedData.metadata);
                    } else {
                        throw new Error('Invalid file format - expected array of products or object with products array');
                    }
                    
                    // Validate product structure
                    const validProducts = importedProducts.filter(p => 
                        p.name && p.filamentType && typeof p.finalPrice === 'number'
                    );
                    
                    if (validProducts.length === 0) {
                        throw new Error('No valid products found in file');
                    }
                    
                    // Ask user what to do with existing data
                    const action = confirm(
                        `Found ${validProducts.length} valid products in file.\n\n` +
                        `Click OK to ADD to existing products (${state.products.length})\n` +
                        `Click Cancel to REPLACE all existing products`
                    );
                    
                    if (action) {
                        // Add to existing products (check for duplicates)
                        const existingNames = new Set(state.products.map(p => p.name.toLowerCase()));
                        const newProducts = validProducts.filter(p => 
                            !existingNames.has(p.name.toLowerCase())
                        );
                        
                        // Update IDs to avoid conflicts
                        newProducts.forEach(p => {
                            p.id = Date.now() + Math.random();
                            p.createdAt = p.createdAt || new Date().toISOString();
                        });
                        
                        state.products.push(...newProducts);
                        alert(`Added ${newProducts.length} new products. Skipped ${validProducts.length - newProducts.length} duplicates.`);
                    } else {
                        // Replace all products
                        validProducts.forEach(p => {
                            p.id = p.id || Date.now() + Math.random();
                            p.createdAt = p.createdAt || new Date().toISOString();
                        });
                        state.products = validProducts;
                        alert(`Replaced all products with ${validProducts.length} imported products.`);
                    }
                    
                    // Save and refresh
                    saveToStorage();
                    triggerAutoExport();
                    await applyFilters();
                    
                } catch (error) {
                    alert(`Import failed: ${error.message}`);
                    console.error('Import error:', error);
                }
            };
            input.click();
        }

        // Load sample data from file or embedded data
        async function loadSampleData() {
            if (state.products.length > 0) {
                if (!confirm('This will add sample products to your existing data. Continue?')) {
                    return;
                }
            }
            
            try {
                // Try to load from sample file first
                const response = await fetch('./sample-products.json');
                if (response.ok) {
                    const sampleProducts = await response.json();
                    
                    // Update IDs to avoid conflicts
                    sampleProducts.forEach(p => {
                        p.id = Date.now() + Math.random();
                        p.createdAt = new Date().toISOString();
                    });
                    
                    state.products.push(...sampleProducts);
                    saveToStorage();
                    triggerAutoExport();
                    await applyFilters();
                    
                    alert(`Added ${sampleProducts.length} sample products from data file!`);
                    return;
                }
            } catch (error) {
                console.log('Could not load sample file, using embedded data:', error);
            }
            
            // Fallback to embedded sample data
            const sampleProducts = [
                {
                    id: Date.now() + 1,
                    name: "Phone Stand - Basic",
                    filamentType: "PLA",
                    customDensity: 1.20,
                    filamentDiameter: 1.75,
                    filamentLength: 5.2,
                    filamentPrice: 450,
                    filamentWeight: 1,
                    printTime: 2.5,
                    hourlyRate: 50,
                    markup: 15,
                    printerPower: 350,
                    electricityRate: 3.50,
                    maintenanceCostPerHour: 8.50,
                    materialCost: 7.02,
                    laborCost: 125.00,
                    operationalCost: 23.13,
                    finalPrice: 178.38,
                    profit: 23.23,
                    createdAt: new Date().toISOString()
                },
                {
                    id: Date.now() + 2,
                    name: "Miniature Figure",
                    filamentType: "ABS",
                    customDensity: 1.20,
                    filamentDiameter: 1.75,
                    filamentLength: 12.8,
                    filamentPrice: 480,
                    filamentWeight: 1,
                    printTime: 4.0,
                    hourlyRate: 50,
                    markup: 20,
                    printerPower: 350,
                    electricityRate: 3.50,
                    maintenanceCostPerHour: 8.50,
                    materialCost: 16.13,
                    laborCost: 200.00,
                    operationalCost: 46.00,
                    finalPrice: 314.56,
                    profit: 52.43,
                    createdAt: new Date().toISOString()
                },
                {
                    id: Date.now() + 3,
                    name: "Custom Bracket",
                    filamentType: "PETG",
                    customDensity: 1.20,
                    filamentDiameter: 1.75,
                    filamentLength: 3.1,
                    filamentPrice: 520,
                    filamentWeight: 1,
                    printTime: 1.5,
                    hourlyRate: 75,
                    markup: 25,
                    printerPower: 350,
                    electricityRate: 3.50,
                    maintenanceCostPerHour: 8.50,
                    materialCost: 5.09,
                    laborCost: 112.50,
                    operationalCost: 18.00,
                    finalPrice: 169.49,
                    profit: 33.90,
                    createdAt: new Date().toISOString()
                }
            ];
            
            state.products.push(...sampleProducts);
            saveToStorage();
            triggerAutoExport();
            await applyFilters();
            
            alert(`Added ${sampleProducts.length} sample products to help you get started!`);
        }

        // PWA functions
        function installApp() {
            if (state.deferredPrompt) {
                state.deferredPrompt.prompt();
                state.deferredPrompt.userChoice.then((choiceResult) => {
                    state.deferredPrompt = null;
                    state.showInstallButton = false;
                    render();
                });
            }
        }

        // Initialize app
        async function init() {
            try {
                // Initialize PouchDB database first
                await initDatabase();
                
                // Migrate existing data in order: IndexedDB -> localStorage -> PouchDB
                await migrateFromIndexedDB();
                await migrateFromLocalStorage();
                
                // Load products from PouchDB
                await loadFromDatabase();
                
                // Initialize filtered products
                state.filteredProducts = state.products;
                
                // Load auto-export preference
                try {
                    const autoExportPref = localStorage.getItem('autoExportEnabled');
                    if (autoExportPref !== null) {
                        state.autoExportEnabled = autoExportPref === 'true';
                    }
                } catch (e) {
                    console.warn('Could not load auto-export preference');
                }
                
                // Setup auto-backup monitoring
                setupAutoBackup();
                
                console.log(`App initialization complete with PouchDB. Auto-export: ${state.autoExportEnabled ? 'enabled' : 'disabled'}`);
            } catch (e) {
                console.error('PouchDB initialization failed, falling back to localStorage:', e);
                loadFromStorage();
            }
            
            // PWA setup
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                state.deferredPrompt = e;
                state.showInstallButton = true;
                render();
            });

            // Service worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('data:application/javascript;base64,' + btoa(`
                    const CACHE_NAME = '3d-print-calc-v1.1';
                    
                    self.addEventListener('install', (event) => {
                        console.log('Service Worker installing');
                        self.skipWaiting();
                    });

                    self.addEventListener('activate', (event) => {
                        console.log('Service Worker activated');
                        event.waitUntil(self.clients.claim());
                    });

                    self.addEventListener('fetch', (event) => {
                        if (event.request.method === 'GET') {
                            event.respondWith(
                                caches.match(event.request)
                                    .then((response) => {
                                        if (response) return response;
                                        return fetch(event.request).catch(() => {
                                            if (event.request.mode === 'navigate') {
                                                return new Response('<h1>App works offline</h1>', {
                                                    headers: { 'Content-Type': 'text/html' }
                                                });
                                            }
                                        });
                                    })
                            );
                        }
                    });
                `)).catch(console.log);
            }

            render();
        }

        // Start the app
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
