<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="3D Printing Business Cost Calculator for South Africa">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="PrintCalc">
    <title>3D Print Cost Calculator</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // Global state
        let state = {
            // PWA
            deferredPrompt: null,
            showInstallButton: false,
            
            // Calculator
            filamentType: 'PLA',
            customDensity: 1.20,
            filamentDiameter: 1.75,
            filamentLength: 1,
            filamentPrice: 450,
            filamentWeight: 1,
            printTime: 2,
            hourlyRate: 0,
            markup: 15,
            printerPower: 1,
            electricityRate: 3.50,
            maintenanceCostPerHour: 8.50,
            
            // Products
            products: [],
            productName: '',
            editingProduct: null,
            showMobileMenu: false,
            
            // Cost overrides (removed)
        };

        // Filament types
        const filamentTypes = {
            ABS: { name: 'Acrylonitrile Butadiene Styrene', density: 1.05 },
            PLA: { name: 'Polylactic Acid', density: 1.27 },
            PETG: { name: 'Polyethylene Terephthalate', density: 1.25 },
            PETT: { name: 'T-Glase filament', density: 1.45 },
            HIPS: { name: 'High Impact Polystyrene', density: 1.04 },
            TPU: { name: 'Thermoplastic Polyurethane', density: 1.30 },
            CUSTOM: { name: 'Custom Material', density: 1.20 }
        };

        // Calculation functions
        function getCurrentDensity() {
            return state.filamentType === 'CUSTOM' ? state.customDensity : filamentTypes[state.filamentType].density;
        }

        function calculateVolume() {
            const radius = state.filamentDiameter / 2;
            return Math.PI * Math.pow(radius, 2) * state.filamentLength / 1000;
        }

        function calculateMaterialCost() {
            const density = getCurrentDensity();
            const volume = calculateVolume();
            const mass = (volume * density) / 1000;
            const pricePerKg = state.filamentPrice / state.filamentWeight;
            return mass * pricePerKg;
        }

        function calculatePowerCost() {
            const powerConsumptionKwh = (state.printerPower / 1000) * state.printTime;
            return powerConsumptionKwh * state.electricityRate;
        }

        function calculateMaintenanceCost() {
            return state.printTime * state.maintenanceCostPerHour;
        }

        function calculateLaborCost() {
            return state.printTime * state.hourlyRate;
        }

        function calculateOperationalCost() {
            return calculatePowerCost() + calculateMaintenanceCost();
        }

        function calculateSubtotal() {
            return calculateMaterialCost() + calculateLaborCost() + calculateOperationalCost();
        }

        function calculateFinalPrice() {
            const subtotal = calculateSubtotal();
            return subtotal * (1 + state.markup / 100);
        }

        function calculateProfit() {
            return calculateFinalPrice() - calculateSubtotal();
        }

        // Cost editing functions (removed)

        // Product functions
        function saveProduct() {
            if (!state.productName.trim()) return;

            const productData = {
                id: state.editingProduct ? state.editingProduct.id : Date.now(),
                name: state.productName,
                filamentType: state.filamentType,
                customDensity: state.customDensity,
                filamentDiameter: state.filamentDiameter,
                filamentLength: state.filamentLength,
                filamentPrice: state.filamentPrice,
                filamentWeight: state.filamentWeight,
                printTime: state.printTime,
                hourlyRate: state.hourlyRate,
                markup: state.markup,
                printerPower: state.printerPower,
                electricityRate: state.electricityRate,
                maintenanceCostPerHour: state.maintenanceCostPerHour,
                materialCost: calculateMaterialCost(),
                laborCost: calculateLaborCost(),
                operationalCost: calculateOperationalCost(),
                finalPrice: calculateFinalPrice(),
                profit: calculateProfit(),
                createdAt: new Date().toISOString()
            };

            if (state.editingProduct) {
                state.products = state.products.map(p => p.id === state.editingProduct.id ? productData : p);
                state.editingProduct = null;
            } else {
                state.products.push(productData);
            }

            state.productName = '';
            saveToStorage();
            render();
        }

        function editProduct(product) {
            state.editingProduct = product;
            state.productName = product.name;
            state.filamentType = product.filamentType;
            state.customDensity = product.customDensity;
            state.filamentDiameter = product.filamentDiameter;
            state.filamentLength = product.filamentLength;
            state.filamentPrice = product.filamentPrice;
            state.filamentWeight = product.filamentWeight;
            state.printTime = product.printTime;
            state.hourlyRate = product.hourlyRate;
            state.markup = product.markup;
            state.printerPower = product.printerPower;
            state.electricityRate = product.electricityRate;
            state.maintenanceCostPerHour = product.maintenanceCostPerHour;
            state.showMobileMenu = false;
            render();
        }

        function deleteProduct(id) {
            if (confirm('Are you sure you want to delete this product?')) {
                state.products = state.products.filter(p => p.id !== id);
                saveToStorage();
                render();
            }
        }

        function duplicateProduct(product) {
            const duplicatedProduct = {
                ...product,
                id: Date.now(),
                name: product.name + ' (Copy)',
                createdAt: new Date().toISOString()
            };
            state.products.push(duplicatedProduct);
            saveToStorage();
            render();
        }

        function clearCalculator() {
            if (renderTimeout) {
                clearTimeout(renderTimeout);
            }
            state.editingProduct = null;
            state.productName = '';
            state.filamentType = 'PLA';
            state.customDensity = 1.20;
            state.filamentDiameter = 1.75;
            state.filamentLength = 1;
            state.filamentPrice = 450;
            state.filamentWeight = 1;
            state.printTime = 2;
            state.hourlyRate = 0;
            state.markup = 15;
            state.printerPower = 1;
            state.electricityRate = 3.50;
            state.maintenanceCostPerHour = 8.50;
            // resetAllCosts removed
        }

        // Storage functions
        function saveToStorage() {
            try {
                localStorage.setItem('3d_printing_products', JSON.stringify(state.products));
            } catch (e) {
                console.log('Storage error:', e);
            }
        }

        function loadFromStorage() {
            try {
                const saved = localStorage.getItem('3d_printing_products');
                if (saved) {
                    state.products = JSON.parse(saved);
                }
            } catch (e) {
                console.log('Load error:', e);
            }
        }

        // Render function
        function render() {
            const app = document.getElementById('app');
            
            app.innerHTML = `
                <div class="max-w-7xl mx-auto p-2 md:p-6 bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
                    ${state.showInstallButton ? `
                        <div class="bg-blue-600 text-white p-4 rounded-lg mb-4 flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <span>üì±</span>
                                <div>
                                    <h3 class="font-semibold">Install App</h3>
                                    <p class="text-sm opacity-90">Add to home screen for quick access</p>
                                </div>
                            </div>
                            <button onclick="installApp()" class="bg-white text-blue-600 px-4 py-2 rounded-lg font-medium hover:bg-gray-100">
                                Install
                            </button>
                        </div>
                    ` : ''}

                    <!-- Header -->
                    <div class="mb-6 text-center">
                        <h1 class="text-2xl md:text-4xl font-bold text-gray-800 mb-2 flex items-center justify-center gap-3">
                            üßÆ 3D Print Calculator
                        </h1>
                        <p class="text-gray-600 text-sm md:text-base">Calculate costs and manage your 3D printing business</p>
                    </div>

                    <!-- Mobile Layout -->
                    <div class="block lg:hidden">
                        <!-- Mobile Navigation -->
                        <div class="bg-white rounded-lg shadow-lg mb-4">
                            <div class="flex border-b">
                                <button onclick="toggleMobileMenu(false)" class="flex-1 py-3 px-4 text-center font-medium ${!state.showMobileMenu ? 'bg-blue-600 text-white' : 'text-gray-600'}">
                                    Calculator
                                </button>
                                <button onclick="toggleMobileMenu(true)" class="flex-1 py-3 px-4 text-center font-medium ${state.showMobileMenu ? 'bg-blue-600 text-white' : 'text-gray-600'}">
                                    Products (${state.products.length})
                                </button>
                            </div>
                        </div>

                        ${!state.showMobileMenu ? renderMobileCalculator() : renderMobileProducts()}
                    </div>

                    <!-- Desktop Layout -->
                    <div class="hidden lg:block">
                        <div class="grid lg:grid-cols-2 gap-6">
                            ${renderDesktopCalculator()}
                            ${renderDesktopResults()}
                        </div>
                        ${renderDesktopProducts()}
                    </div>
                </div>
            `;
        }

        // renderCostValue function removed

        function renderMobileCalculator() {
            return `
                <div class="space-y-4">
                    <!-- Cost Breakdown -->
                    <div class="bg-white rounded-lg shadow-lg p-4">
                        <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2 mb-4">
                            üí∞ Cost Breakdown
                        </h2>

                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div class="bg-blue-50 rounded-lg p-3">
                                <h3 class="font-semibold text-blue-800 mb-1">Material</h3>
                                <div class="text-lg font-bold">R${calculateMaterialCost().toFixed(2)}</div>
                            </div>

                            <div class="bg-green-50 rounded-lg p-3">
                                <h3 class="font-semibold text-green-800 mb-1">Labour</h3>
                                <div class="text-lg font-bold">R${calculateLaborCost().toFixed(2)}</div>
                            </div>

                            <div class="bg-yellow-50 rounded-lg p-3">
                                <h3 class="font-semibold text-yellow-800 mb-1">Operational</h3>
                                <div class="text-lg font-bold">R${calculateOperationalCost().toFixed(2)}</div>
                            </div>

                            <div class="bg-purple-50 rounded-lg p-3">
                                <h3 class="font-semibold text-purple-800 mb-1">Profit</h3>
                                <div class="text-lg font-bold">R${calculateProfit().toFixed(2)}</div>
                            </div>
                        </div>

                        <div class="bg-indigo-100 rounded-lg p-4 mt-4 border-2 border-indigo-300">
                            <h3 class="font-semibold text-indigo-800 mb-2">Final Selling Price</h3>
                            <div class="text-2xl font-bold">R${calculateFinalPrice().toFixed(2)}</div>
                        </div>
                    </div>

                    <!-- Settings -->
                    <div class="bg-white rounded-lg shadow-lg p-4">
                        <h2 class="text-xl font-semibold mb-4 text-gray-800 flex items-center gap-2">
                            ‚öôÔ∏è ${state.editingProduct ? `Editing: ${state.editingProduct.name}` : 'Settings'}
                        </h2>

                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Product Name</label>
                                <input 
                                    type="text" 
                                    value="${state.productName}" 
                                    oninput="updateState('productName', this.value)"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 ${state.editingProduct ? 'bg-blue-50 border-blue-300' : ''}"
                                    placeholder="Enter product name"
                                />
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Material</label>
                                <select onchange="updateStateImmediate('filamentType', this.value)" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                                    ${Object.keys(filamentTypes).map(key => 
                                        `<option value="${key}" ${state.filamentType === key ? 'selected' : ''}>${key}</option>`
                                    ).join('')}
                                </select>
                            </div>

                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Length (m)</label>
                                    <input 
                                        type="number" 
                                        step="0.1" 
                                        value="${state.filamentLength}" 
                                        oninput="updateState('filamentLength', parseFloat(this.value) || 0)"
                                        class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Time (hours)</label>
                                    <input 
                                        type="number" 
                                        step="0.1" 
                                        value="${state.printTime}" 
                                        oninput="updateState('printTime', parseFloat(this.value) || 0)"
                                        class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Price (R)</label>
                                    <input 
                                        type="number" 
                                        step="0.01" 
                                        value="${state.filamentPrice}" 
                                        oninput="updateState('filamentPrice', parseFloat(this.value) || 0)"
                                        class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Rate (R/h)</label>
                                    <input 
                                        type="number" 
                                        step="0.01" 
                                        value="${state.hourlyRate}" 
                                        oninput="updateState('hourlyRate', parseFloat(this.value) || 0)"
                                        class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>
                            </div>
                        </div>

                        <div class="flex gap-3 mt-4">
                            <button 
                                onclick="saveProduct()" 
                                ${!state.productName.trim() ? 'disabled' : ''}
                                class="flex-1 bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 disabled:opacity-50 font-medium"
                            >
                                üíæ ${state.editingProduct ? 'Update' : 'Save'}
                            </button>
                            <button onclick="clearCalculator()" class="bg-gray-500 text-white py-3 px-4 rounded-lg hover:bg-gray-600">
                                Clear
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMobileProducts() {
            if (state.products.length === 0) {
                return `
                    <div class="bg-white rounded-lg shadow-lg p-4">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Products</h2>
                        <p class="text-gray-500 text-center py-8">No products saved yet</p>
                    </div>
                `;
            }

            return `
                <div class="bg-white rounded-lg shadow-lg p-4">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">Products</h2>
                        <button onclick="exportProducts()" class="text-blue-600 hover:text-blue-800 text-sm">
                            üì• Export
                        </button>
                    </div>
                    
                    <div class="space-y-3">
                        ${state.products.map(product => `
                            <div class="border border-gray-200 rounded-lg p-3">
                                <div class="flex justify-between items-start mb-2">
                                    <h3 class="font-semibold text-gray-800">${product.name}</h3>
                                    <div class="flex gap-2">
                                        <button onclick="editProduct(${JSON.stringify(product).replace(/"/g, '&quot;')})" class="text-blue-600 hover:text-blue-800 p-1">
                                            ‚úèÔ∏è
                                        </button>
                                        <button onclick="deleteProduct(${product.id})" class="text-red-600 hover:text-red-800 p-1">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-2 text-sm">
                                    <div>
                                        <span class="text-gray-600">Material:</span>
                                        <span class="ml-2 font-medium">${product.filamentType}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-600">Time:</span>
                                        <span class="ml-2 font-medium">${product.printTime}h</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-600">Cost:</span>
                                        <span class="ml-2 font-medium">R${(product.materialCost + product.laborCost + product.operationalCost).toFixed(2)}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-600">Price:</span>
                                        <span class="ml-2 font-bold text-green-600">R${product.finalPrice.toFixed(2)}</span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderDesktopCalculator() {
            return `
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-semibold mb-6 text-gray-800 flex items-center gap-2">
                        ‚öôÔ∏è ${state.editingProduct ? `Editing: ${state.editingProduct.name}` : 'Calculator Settings'}
                    </h2>

                    <div class="space-y-6">
                        <!-- Product Name -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Product Name</label>
                            <input 
                                type="text" 
                                value="${state.productName}" 
                                oninput="updateState('productName', this.value)"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 ${state.editingProduct ? 'bg-blue-50 border-blue-300' : ''}"
                                placeholder="Enter product name for saving"
                            />
                        </div>

                        <!-- Material Settings -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h3 class="text-lg font-medium text-gray-800 mb-4 flex items-center gap-2">
                                üé® Material Settings
                            </h3>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Filament Type</label>
                                    <select onchange="updateStateImmediate('filamentType', this.value)" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                        ${Object.keys(filamentTypes).map(key => 
                                            `<option value="${key}" ${state.filamentType === key ? 'selected' : ''}>${key} - ${filamentTypes[key].name}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                
                                ${state.filamentType === 'CUSTOM' ? `
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Custom Density (g/cm¬≥)</label>
                                        <input 
                                            type="number" 
                                            step="0.01" 
                                            value="${state.customDensity}" 
                                            oninput="updateState('customDensity', parseFloat(this.value) || 0)"
                                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        />
                                    </div>
                                ` : `
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Density (g/cm¬≥)</label>
                                        <input 
                                            type="text" 
                                            value="${getCurrentDensity()}" 
                                            disabled
                                            class="w-full p-2 border border-gray-300 rounded-lg bg-gray-100"
                                        />
                                    </div>
                                `}

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Filament Diameter (mm)</label>
                                    <input 
                                        type="number" 
                                        step="0.01" 
                                        value="${state.filamentDiameter}" 
                                        oninput="updateState('filamentDiameter', parseFloat(this.value) || 0)"
                                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Filament Length (m)</label>
                                    <input 
                                        type="number" 
                                        step="0.1" 
                                        value="${state.filamentLength}" 
                                        oninput="updateState('filamentLength', parseFloat(this.value) || 0)"
                                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Filament Price (R)</label>
                                    <input 
                                        type="number" 
                                        step="1" 
                                        value="${state.filamentPrice}" 
                                        oninput="updateState('filamentPrice', parseFloat(this.value) || 0)"
                                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Filament Weight (kg)</label>
                                    <input 
                                        type="number" 
                                        step="0.1" 
                                        value="${state.filamentWeight}" 
                                        oninput="updateState('filamentWeight', parseFloat(this.value) || 0)"
                                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>
                            </div>
                        </div>

                        <!-- Production Settings -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h3 class="text-lg font-medium text-gray-800 mb-4 flex items-center gap-2">
                                ‚è±Ô∏è Production Settings
                            </h3>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Print Time (hours)</label>
                                    <input 
                                        type="number" 
                                        step="0.1" 
                                        value="${state.printTime}" 
                                        oninput="updateState('printTime', parseFloat(this.value) || 0)"
                                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Hourly Rate (R/hour)</label>
                                    <input 
                                        type="number" 
                                        step="10" 
                                        value="${state.hourlyRate}" 
                                        oninput="updateState('hourlyRate', parseFloat(this.value) || 0)"
                                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Markup (%)</label>
                                    <input 
                                        type="number" 
                                        step="5" 
                                        value="${state.markup}" 
                                        oninput="updateState('markup', parseFloat(this.value) || 0)"
                                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Printer Power (W)</label>
                                    <input 
                                        type="number" 
                                        step="10" 
                                        value="${state.printerPower}" 
                                        oninput="updateState('printerPower', parseFloat(this.value) || 0)"
                                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Electricity Rate (R/kWh)</label>
                                    <input 
                                        type="number" 
                                        step="0.1" 
                                        value="${state.electricityRate}" 
                                        oninput="updateState('electricityRate', parseFloat(this.value) || 0)"
                                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Maintenance (R/hour)</label>
                                    <input 
                                        type="number" 
                                        step="0.5" 
                                        value="${state.maintenanceCostPerHour}" 
                                        oninput="updateState('maintenanceCostPerHour', parseFloat(this.value) || 0)"
                                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex gap-3">
                            <button 
                                onclick="saveProduct()" 
                                ${!state.productName.trim() ? 'disabled' : ''}
                                class="flex-1 bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 disabled:opacity-50 font-medium transition-colors"
                            >
                                üíæ ${state.editingProduct ? 'Update Product' : 'Save Product'}
                            </button>
                            <button onclick="clearCalculator()" class="bg-gray-500 text-white py-3 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                                üîÑ Clear
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDesktopResults() {
            return `
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-semibold mb-6 text-gray-800 flex items-center gap-2">
                        üí∞ Cost Breakdown
                    </h2>

                    <div class="space-y-6">
                        <!-- Summary Cards -->
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-lg p-4">
                                <h3 class="text-lg font-medium mb-2">Material Cost</h3>
                                <div class="text-2xl font-bold">R${calculateMaterialCost().toFixed(2)}</div>
                                <p class="text-sm mt-2 opacity-90">
                                    ${(calculateVolume() * getCurrentDensity() / 1000).toFixed(3)} kg used
                                </p>
                            </div>

                            <div class="bg-gradient-to-br from-green-500 to-green-600 text-white rounded-lg p-4">
                                <h3 class="text-lg font-medium mb-2">Labour Cost</h3>
                                <div class="text-2xl font-bold">R${calculateLaborCost().toFixed(2)}</div>
                                <p class="text-sm mt-2 opacity-90">
                                    ${state.printTime} hours @ R${state.hourlyRate}/hr
                                </p>
                            </div>

                            <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 text-white rounded-lg p-4">
                                <h3 class="text-lg font-medium mb-2">Operational Cost</h3>
                                <div class="text-2xl font-bold">R${calculateOperationalCost().toFixed(2)}</div>
                                <p class="text-sm mt-2 opacity-90">
                                    Power: R${calculatePowerCost().toFixed(2)} | Maint: R${calculateMaintenanceCost().toFixed(2)}
                                </p>
                            </div>

                            <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-lg p-4">
                                <h3 class="text-lg font-medium mb-2">Profit (${state.markup}%)</h3>
                                <div class="text-2xl font-bold">R${calculateProfit().toFixed(2)}</div>
                                <p class="text-sm mt-2 opacity-90">
                                    Markup on subtotal
                                </p>
                            </div>
                        </div>

                        <!-- Detailed Breakdown -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h3 class="text-lg font-medium text-gray-800 mb-3">Detailed Breakdown</h3>
                            
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between py-2 border-b border-gray-200">
                                    <span class="text-gray-600">Material Volume</span>
                                    <span class="font-medium">${calculateVolume().toFixed(2)} cm¬≥</span>
                                </div>
                                <div class="flex justify-between py-2 border-b border-gray-200">
                                    <span class="text-gray-600">Material Weight</span>
                                    <span class="font-medium">${(calculateVolume() * getCurrentDensity() / 1000).toFixed(3)} kg</span>
                                </div>
                                <div class="flex justify-between py-2 border-b border-gray-200">
                                    <span class="text-gray-600">Price per kg</span>
                                    <span class="font-medium">R${(state.filamentPrice / state.filamentWeight).toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between py-2 border-b border-gray-200">
                                    <span class="text-gray-600">Power Consumption</span>
                                    <span class="font-medium">${((state.printerPower / 1000) * state.printTime).toFixed(2)} kWh</span>
                                </div>
                                <div class="flex justify-between py-2 border-b border-gray-200">
                                    <span class="text-gray-600">Subtotal (before markup)</span>
                                    <span class="font-semibold">R${calculateSubtotal().toFixed(2)}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Final Price -->
                        <div class="bg-gradient-to-br from-indigo-600 to-indigo-700 text-white rounded-lg p-6">
                            <h3 class="text-xl font-semibold mb-3">Final Selling Price</h3>
                            <div class="text-3xl font-bold">R${calculateFinalPrice().toFixed(2)}</div>
                            
                            <div class="mt-4 pt-4 border-t border-white border-opacity-30">
                                <div class="flex justify-between text-sm">
                                    <span>Cost</span>
                                    <span>R${calculateSubtotal().toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between text-sm mt-1">
                                    <span>Profit</span>
                                    <span>R${calculateProfit().toFixed(2)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDesktopProducts() {
            if (state.products.length === 0) return '';
            
            return `
                <div class="bg-white rounded-xl shadow-lg p-6 mt-6 lg:col-span-2">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold text-gray-800 flex items-center gap-2">
                            üì¶ Saved Products (${state.products.length})
                        </h2>
                        <div class="flex gap-3">
                            <button onclick="exportProducts()" class="text-blue-600 hover:text-blue-800 font-medium">
                                üì• Export All
                            </button>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b-2 border-gray-200">
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Product Name</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Material</th>
                                    <th class="text-right py-3 px-4 font-semibold text-gray-700">Length</th>
                                    <th class="text-right py-3 px-4 font-semibold text-gray-700">Time</th>
                                    <th class="text-right py-3 px-4 font-semibold text-gray-700">Material Cost</th>
                                    <th class="text-right py-3 px-4 font-semibold text-gray-700">Labour Cost</th>
                                    <th class="text-right py-3 px-4 font-semibold text-gray-700">Operational</th>
                                    <th class="text-right py-3 px-4 font-semibold text-gray-700">Total Cost</th>
                                    <th class="text-right py-3 px-4 font-semibold text-gray-700">Selling Price</th>
                                    <th class="text-right py-3 px-4 font-semibold text-gray-700">Profit</th>
                                    <th class="text-center py-3 px-4 font-semibold text-gray-700">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${state.products.map((product, index) => `
                                    <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors ${state.editingProduct && state.editingProduct.id === product.id ? 'bg-blue-50' : ''}">
                                        <td class="py-3 px-4">
                                            <div class="font-medium text-gray-900">${product.name}</div>
                                            <div class="text-xs text-gray-500">${new Date(product.createdAt).toLocaleDateString()}</div>
                                        </td>
                                        <td class="py-3 px-4 text-gray-700">${product.filamentType}</td>
                                        <td class="py-3 px-4 text-right text-gray-700">${product.filamentLength}m</td>
                                        <td class="py-3 px-4 text-right text-gray-700">${product.printTime}h</td>
                                        <td class="py-3 px-4 text-right text-gray-700">R${product.materialCost.toFixed(2)}</td>
                                        <td class="py-3 px-4 text-right text-gray-700">R${product.laborCost.toFixed(2)}</td>
                                        <td class="py-3 px-4 text-right text-gray-700">R${product.operationalCost.toFixed(2)}</td>
                                        <td class="py-3 px-4 text-right font-medium text-gray-900">
                                            R${(product.materialCost + product.laborCost + product.operationalCost).toFixed(2)}
                                        </td>
                                        <td class="py-3 px-4 text-right font-bold text-green-600">
                                            R${product.finalPrice.toFixed(2)}
                                        </td>
                                        <td class="py-3 px-4 text-right font-medium text-purple-600">
                                            R${product.profit.toFixed(2)}
                                        </td>
                                        <td class="py-3 px-4">
                                            <div class="flex justify-center gap-2">
                                                <button 
                                                    onclick="editProduct(${JSON.stringify(product).replace(/"/g, '&quot;')})" 
                                                    class="text-blue-600 hover:text-blue-800 p-1"
                                                    title="Edit"
                                                >
                                                    ‚úèÔ∏è
                                                </button>
                                                <button 
                                                    onclick="duplicateProduct(${JSON.stringify(product).replace(/"/g, '&quot;')})" 
                                                    class="text-green-600 hover:text-green-800 p-1"
                                                    title="Duplicate"
                                                >
                                                    üìã
                                                </button>
                                                <button 
                                                    onclick="deleteProduct(${product.id})" 
                                                    class="text-red-600 hover:text-red-800 p-1"
                                                    title="Delete"
                                                >
                                                    üóëÔ∏è
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                            <tfoot>
                                <tr class="border-t-2 border-gray-200 font-semibold">
                                    <td colspan="4" class="py-3 px-4 text-gray-700">Totals</td>
                                    <td class="py-3 px-4 text-right text-gray-700">
                                        R${state.products.reduce((sum, p) => sum + p.materialCost, 0).toFixed(2)}
                                    </td>
                                    <td class="py-3 px-4 text-right text-gray-700">
                                        R${state.products.reduce((sum, p) => sum + p.laborCost, 0).toFixed(2)}
                                    </td>
                                    <td class="py-3 px-4 text-right text-gray-700">
                                        R${state.products.reduce((sum, p) => sum + p.operationalCost, 0).toFixed(2)}
                                    </td>
                                    <td class="py-3 px-4 text-right text-gray-900">
                                        R${state.products.reduce((sum, p) => sum + p.materialCost + p.laborCost + p.operationalCost, 0).toFixed(2)}
                                    </td>
                                    <td class="py-3 px-4 text-right text-green-600">
                                        R${state.products.reduce((sum, p) => sum + p.finalPrice, 0).toFixed(2)}
                                    </td>
                                    <td class="py-3 px-4 text-right text-purple-600">
                                        R${state.products.reduce((sum, p) => sum + p.profit, 0).toFixed(2)}
                                    </td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            `;
        }

        // Event handlers
        let renderTimeout = null;
        function updateState(key, value) {
            state[key] = value;
            
            // Debounce rendering to prevent focus loss
            if (renderTimeout) {
                clearTimeout(renderTimeout);
            }
            renderTimeout = setTimeout(() => {
                render();
            }, 300);
        }
        
        // Immediate update for non-input changes
        function updateStateImmediate(key, value) {
            state[key] = value;
            render();
        }

        function toggleMobileMenu(show) {
            state.showMobileMenu = show;
            render();
        }

        function exportProducts() {
            const dataStr = JSON.stringify(state.products, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = `3d-print-products-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        // PWA functions
        function installApp() {
            if (state.deferredPrompt) {
                state.deferredPrompt.prompt();
                state.deferredPrompt.userChoice.then((choiceResult) => {
                    state.deferredPrompt = null;
                    state.showInstallButton = false;
                    render();
                });
            }
        }

        // Initialize app
        function init() {
            loadFromStorage();
            
            // PWA setup
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                state.deferredPrompt = e;
                state.showInstallButton = true;
                render();
            });

            // Service worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('data:application/javascript;base64,' + btoa(`
                    const CACHE_NAME = '3d-print-calc-v1';
                    
                    self.addEventListener('install', (event) => {
                        console.log('Service Worker installing');
                        self.skipWaiting();
                    });

                    self.addEventListener('activate', (event) => {
                        console.log('Service Worker activated');
                        event.waitUntil(self.clients.claim());
                    });

                    self.addEventListener('fetch', (event) => {
                        if (event.request.method === 'GET') {
                            event.respondWith(
                                caches.match(event.request)
                                    .then((response) => {
                                        if (response) return response;
                                        return fetch(event.request).catch(() => {
                                            if (event.request.mode === 'navigate') {
                                                return new Response('<h1>App works offline</h1>', {
                                                    headers: { 'Content-Type': 'text/html' }
                                                });
                                            }
                                        });
                                    })
                            );
                        }
                    });
                `)).catch(console.log);
            }

            render();
        }

        // Start the app
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
