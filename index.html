<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="3D Printing Business Cost Calculator for South Africa">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="PrintCalc">
    <title>3D Print Cost Calculator</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
        }
        .editable-cost {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .editable-cost:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        .manual-override {
            background-color: rgba(255, 255, 255, 0.5) !important;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // Global state
        let state = {
            // PWA
            deferredPrompt: null,
            showInstallButton: false,
            
            // Calculator
            filamentType: 'PLA',
            customDensity: 1.20,
            filamentDiameter: 1.75,
            filamentLength: 10,
            filamentPrice: 450,
            filamentWeight: 1,
            printTime: 2,
            hourlyRate: 250,
            markup: 50,
            printerPower: 250,
            electricityRate: 3.50,
            maintenanceCostPerHour: 8.50,
            
            // Products
            products: [],
            productName: '',
            editingProduct: null,
            showMobileMenu: false,
            
            // Cost overrides
            manualOverrides: {
                materialCost: null,
                laborCost: null,
                operationalCost: null,
                profit: null,
                finalPrice: null
            },
            editingCost: null
        };

        // Filament types
        const filamentTypes = {
            ABS: { name: 'Acrylonitrile Butadiene Styrene', density: 1.05 },
            PLA: { name: 'Polylactic Acid', density: 1.27 },
            PETG: { name: 'Polyethylene Terephthalate', density: 1.25 },
            PETT: { name: 'T-Glase filament', density: 1.45 },
            HIPS: { name: 'High Impact Polystyrene', density: 1.04 },
            TPU: { name: 'Thermoplastic Polyurethane', density: 1.30 },
            CUSTOM: { name: 'Custom Material', density: 1.20 }
        };

        // Calculation functions
        function getCurrentDensity() {
            return state.filamentType === 'CUSTOM' ? state.customDensity : filamentTypes[state.filamentType].density;
        }

        function calculateVolume() {
            const radius = state.filamentDiameter / 2;
            return Math.PI * Math.pow(radius, 2) * state.filamentLength / 1000;
        }

        function calculateMaterialCost() {
            if (state.manualOverrides.materialCost !== null) return state.manualOverrides.materialCost;
            const density = getCurrentDensity();
            const volume = calculateVolume();
            const mass = (volume * density) / 1000;
            const pricePerKg = state.filamentPrice / state.filamentWeight;
            return mass * pricePerKg;
        }

        function calculatePowerCost() {
            const powerConsumptionKwh = (state.printerPower / 1000) * state.printTime;
            return powerConsumptionKwh * state.electricityRate;
        }

        function calculateMaintenanceCost() {
            return state.printTime * state.maintenanceCostPerHour;
        }

        function calculateLaborCost() {
            if (state.manualOverrides.laborCost !== null) return state.manualOverrides.laborCost;
            return state.printTime * state.hourlyRate;
        }

        function calculateOperationalCost() {
            if (state.manualOverrides.operationalCost !== null) return state.manualOverrides.operationalCost;
            return calculatePowerCost() + calculateMaintenanceCost();
        }

        function calculateSubtotal() {
            return calculateMaterialCost() + calculateLaborCost() + calculateOperationalCost();
        }

        function calculateFinalPrice() {
            if (state.manualOverrides.finalPrice !== null) return state.manualOverrides.finalPrice;
            const subtotal = calculateSubtotal();
            return subtotal * (1 + state.markup / 100);
        }

        function calculateProfit() {
            if (state.manualOverrides.profit !== null) return state.manualOverrides.profit;
            return calculateFinalPrice() - calculateSubtotal();
        }

        // Cost editing functions
        function editCost(costType) {
            state.editingCost = costType;
            render();
        }

        function saveCostEdit(costType, value) {
            const numValue = parseFloat(value);
            state.manualOverrides[costType] = isNaN(numValue) ? null : numValue;
            state.editingCost = null;
            render();
        }

        function resetCost(costType) {
            state.manualOverrides[costType] = null;
            render();
        }

        function resetAllCosts() {
            state.manualOverrides = {
                materialCost: null,
                laborCost: null,
                operationalCost: null,
                profit: null,
                finalPrice: null
            };
            render();
        }

        // Product functions
        function saveProduct() {
            if (!state.productName.trim()) return;

            const productData = {
                id: state.editingProduct ? state.editingProduct.id : Date.now(),
                name: state.productName,
                filamentType: state.filamentType,
                customDensity: state.customDensity,
                filamentDiameter: state.filamentDiameter,
                filamentLength: state.filamentLength,
                filamentPrice: state.filamentPrice,
                filamentWeight: state.filamentWeight,
                printTime: state.printTime,
                hourlyRate: state.hourlyRate,
                markup: state.markup,
                printerPower: state.printerPower,
                electricityRate: state.electricityRate,
                maintenanceCostPerHour: state.maintenanceCostPerHour,
                materialCost: calculateMaterialCost(),
                laborCost: calculateLaborCost(),
                operationalCost: calculateOperationalCost(),
                finalPrice: calculateFinalPrice(),
                profit: calculateProfit(),
                createdAt: new Date().toISOString()
            };

            if (state.editingProduct) {
                state.products = state.products.map(p => p.id === state.editingProduct.id ? productData : p);
                state.editingProduct = null;
            } else {
                state.products.push(productData);
            }

            state.productName = '';
            saveToStorage();
            render();
        }

        function editProduct(product) {
            state.editingProduct = product;
            state.productName = product.name;
            state.filamentType = product.filamentType;
            state.customDensity = product.customDensity;
            state.filamentDiameter = product.filamentDiameter;
            state.filamentLength = product.filamentLength;
            state.filamentPrice = product.filamentPrice;
            state.filamentWeight = product.filamentWeight;
            state.printTime = product.printTime;
            state.hourlyRate = product.hourlyRate;
            state.markup = product.markup;
            state.printerPower = product.printerPower;
            state.electricityRate = product.electricityRate;
            state.maintenanceCostPerHour = product.maintenanceCostPerHour;
            state.showMobileMenu = false;
            render();
        }

        function deleteProduct(id) {
            if (confirm('Are you sure you want to delete this product?')) {
                state.products = state.products.filter(p => p.id !== id);
                saveToStorage();
                render();
            }
        }

        function clearCalculator() {
            state.editingProduct = null;
            state.productName = '';
            state.filamentType = 'PLA';
            state.customDensity = 1.20;
            state.filamentDiameter = 1.75;
            state.filamentLength = 10;
            state.filamentPrice = 450;
            state.filamentWeight = 1;
            state.printTime = 2;
            state.hourlyRate = 250;
            state.markup = 50;
            state.printerPower = 250;
            state.electricityRate = 3.50;
            state.maintenanceCostPerHour = 8.50;
            resetAllCosts();
        }

        // Storage functions
        function saveToStorage() {
            try {
                localStorage.setItem('3d_printing_products', JSON.stringify(state.products));
            } catch (e) {
                console.log('Storage error:', e);
            }
        }

        function loadFromStorage() {
            try {
                const saved = localStorage.getItem('3d_printing_products');
                if (saved) {
                    state.products = JSON.parse(saved);
                }
            } catch (e) {
                console.log('Load error:', e);
            }
        }

        // Render function
        function render() {
            const app = document.getElementById('app');
            
            app.innerHTML = `
                <div class="max-w-7xl mx-auto p-2 md:p-6 bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
                    ${state.showInstallButton ? `
                        <div class="bg-blue-600 text-white p-4 rounded-lg mb-4 flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <span>📱</span>
                                <div>
                                    <h3 class="font-semibold">Install App</h3>
                                    <p class="text-sm opacity-90">Add to home screen for quick access</p>
                                </div>
                            </div>
                            <button onclick="installApp()" class="bg-white text-blue-600 px-4 py-2 rounded-lg font-medium hover:bg-gray-100">
                                Install
                            </button>
                        </div>
                    ` : ''}

                    <!-- Header -->
                    <div class="mb-6 text-center">
                        <h1 class="text-2xl md:text-4xl font-bold text-gray-800 mb-2 flex items-center justify-center gap-3">
                            🧮 3D Print Calculator
                        </h1>
                        <p class="text-gray-600 text-sm md:text-base">Calculate costs and manage your 3D printing business</p>
                    </div>

                    <!-- Mobile Layout -->
                    <div class="block lg:hidden">
                        <!-- Mobile Navigation -->
                        <div class="bg-white rounded-lg shadow-lg mb-4">
                            <div class="flex border-b">
                                <button onclick="toggleMobileMenu(false)" class="flex-1 py-3 px-4 text-center font-medium ${!state.showMobileMenu ? 'bg-blue-600 text-white' : 'text-gray-600'}">
                                    Calculator
                                </button>
                                <button onclick="toggleMobileMenu(true)" class="flex-1 py-3 px-4 text-center font-medium ${state.showMobileMenu ? 'bg-blue-600 text-white' : 'text-gray-600'}">
                                    Products (${state.products.length})
                                </button>
                            </div>
                        </div>

                        ${!state.showMobileMenu ? renderMobileCalculator() : renderMobileProducts()}
                    </div>

                    <!-- Desktop Layout -->
                    <div class="hidden lg:grid lg:grid-cols-2 gap-6">
                        ${renderDesktopCalculator()}
                        ${renderDesktopResults()}
                    </div>

                    ${state.products.length > 0 ? renderDesktopProducts() : ''}
                </div>
            `;
        }

        function renderCostValue(costType, value, label) {
            const isEditing = state.editingCost === costType;
            const isOverridden = state.manualOverrides[costType] !== null;
            
            if (isEditing) {
                return `
                    <input 
                        type="number" 
                        step="0.01" 
                        value="${value.toFixed(2)}"
                        onblur="saveCostEdit('${costType}', this.value)"
                        onkeydown="if(event.key==='Enter') saveCostEdit('${costType}', this.value)"
                        class="text-lg font-bold bg-white border rounded px-1 w-full"
                        autofocus
                    />
                `;
            }
            
            return `
                <div 
                    class="text-lg font-bold cursor-pointer hover:bg-white hover:bg-opacity-30 rounded px-1 transition-colors ${isOverridden ? 'manual-override' : ''}"
                    onclick="editCost('${costType}')"
                    title="Click to edit"
                >
                    R${value.toFixed(2)}
                </div>
            `;
        }

        function renderMobileCalculator() {
            return `
                <div class="space-y-4">
                    <!-- Cost Breakdown -->
                    <div class="bg-white rounded-lg shadow-lg p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                                💰 Cost Breakdown
                            </h2>
                            ${Object.values(state.manualOverrides).some(v => v !== null) ? `
                                <button onclick="resetAllCosts()" class="text-xs text-gray-600 hover:text-gray-800">
                                    Reset All
                                </button>
                            ` : ''}
                        </div>

                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div class="bg-blue-50 rounded-lg p-3">
                                <div class="flex justify-between items-center mb-1">
                                    <h3 class="font-semibold text-blue-800">Material</h3>
                                    ${state.manualOverrides.materialCost !== null ? `
                                        <button onclick="resetCost('materialCost')" class="text-xs text-red-600">Reset</button>
                                    ` : ''}
                                </div>
                                ${renderCostValue('materialCost', calculateMaterialCost(), 'Material')}
                            </div>

                            <div class="bg-green-50 rounded-lg p-3">
                                <div class="flex justify-between items-center mb-1">
                                    <h3 class="font-semibold text-green-800">Labour</h3>
                                    ${state.manualOverrides.laborCost !== null ? `
                                        <button onclick="resetCost('laborCost')" class="text-xs text-red-600">Reset</button>
                                    ` : ''}
                                </div>
                                ${renderCostValue('laborCost', calculateLaborCost(), 'Labour')}
                            </div>

                            <div class="bg-yellow-50 rounded-lg p-3">
                                <div class="flex justify-between items-center mb-1">
                                    <h3 class="font-semibold text-yellow-800">Operational</h3>
                                    ${state.manualOverrides.operationalCost !== null ? `
                                        <button onclick="resetCost('operationalCost')" class="text-xs text-red-600">Reset</button>
                                    ` : ''}
                                </div>
                                ${renderCostValue('operationalCost', calculateOperationalCost(), 'Operational')}
                            </div>

                            <div class="bg-purple-50 rounded-lg p-3">
                                <div class="flex justify-between items-center mb-1">
                                    <h3 class="font-semibold text-purple-800">Profit</h3>
                                    ${state.manualOverrides.profit !== null ? `
                                        <button onclick="resetCost('profit')" class="text-xs text-red-600">Reset</button>
                                    ` : ''}
                                </div>
                                ${renderCostValue('profit', calculateProfit(), 'Profit')}
                            </div>
                        </div>

                        <div class="bg-indigo-100 rounded-lg p-4 mt-4 border-2 border-indigo-300">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-semibold text-indigo-800">Final Selling Price</h3>
                                ${state.manualOverrides.finalPrice !== null ? `
                                    <button onclick="resetCost('finalPrice')" class="text-xs text-red-600">Reset</button>
                                ` : ''}
                            </div>
                            ${renderCostValue('finalPrice', calculateFinalPrice(), 'Final Price').replace('text-lg', 'text-2xl')}
                        </div>
                    </div>

                    <!-- Settings -->
                    <div class="bg-white rounded-lg shadow-lg p-4">
                        <h2 class="text-xl font-semibold mb-4 text-gray-800 flex items-center gap-2">
                            ⚙️ ${state.editingProduct ? `Editing: ${state.editingProduct.name}` : 'Settings'}
                        </h2>

                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Product Name</label>
                                <input 
                                    type="text" 
                                    value="${state.productName}" 
                                    oninput="updateState('productName', this.value)"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 ${state.editingProduct ? 'bg-blue-50 border-blue-300' : ''}"
                                    placeholder="Enter product name"
                                />
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Material</label>
                                <select onchange="updateState('filamentType', this.value)" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                                    ${Object.keys(filamentTypes).map(key => 
                                        `<option value="${key}" ${state.filamentType === key ? 'selected' : ''}>${key}</option>`
                                    ).join('')}
                                </select>
                            </div>

                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Length (m)</label>
                                    <input 
                                        type="number" 
                                        step="0.1" 
                                        value="${state.filamentLength}" 
                                        oninput="updateState('filamentLength', parseFloat(this.value) || 0)"
                                        class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Time (hours)</label>
                                    <input 
                                        type="number" 
                                        step="0.1" 
                                        value="${state.printTime}" 
                                        oninput="updateState('printTime', parseFloat(this.value) || 0)"
                                        class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Price (R)</label>
                                    <input 
                                        type="number" 
                                        step="0.01" 
                                        value="${state.filamentPrice}" 
                                        oninput="updateState('filamentPrice', parseFloat(this.value) || 0)"
                                        class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Rate (R/h)</label>
                                    <input 
                                        type="number" 
                                        step="0.01" 
                                        value="${state.hourlyRate}" 
                                        oninput="updateState('hourlyRate', parseFloat(this.value) || 0)"
                                        class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>
                            </div>
                        </div>

                        <div class="flex gap-3 mt-4">
                            <button 
                                onclick="saveProduct()" 
                                ${!state.productName.trim() ? 'disabled' : ''}
                                class="flex-1 bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 disabled:opacity-50 font-medium"
                            >
                                💾 ${state.editingProduct ? 'Update' : 'Save'}
                            </button>
                            <button onclick="clearCalculator()" class="bg-gray-500 text-white py-3 px-4 rounded-lg hover:bg-gray-600">
                                Clear
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMobileProducts() {
            if (state.products.length === 0) {
                return `
                    <div class="bg-white rounded-lg shadow-lg p-4">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Products</h2>
                        <p class="text-gray-500 text-center py-8">No products saved yet</p>
                    </div>
                `;
            }

            return `
                <div class="bg-white rounded-lg shadow-lg p-4">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">Products</h2>
                        <button onclick="exportProducts()" class="text-blue-600 hover:text-blue-800 text-sm">
                            📥 Export
                        </button>
                    </div>
                    
                    <div class="space-y-3">
                        ${state.products.map(product => `
                            <div class="border border-gray-200 rounded-lg p-3">
                                <div class="flex justify-between items-start mb-2">
                                    <h3 class="font-semibold text-gray-800">${product.name}</h3>
                                    <div class="flex gap-2">
                                        <button onclick="editProduct(${JSON.stringify(product).replace(/"/g, '&quot;')})" class="text-blue-600 hover:text-blue-800 p-1">
                                            ✏️
                                        </button>
                                        <button onclick="deleteProduct(${product.id})" class="text-red-600 hover:text-red-800 p-1">
                                            🗑️
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-2 text-sm">
                                    <div>
                                        <span class="text-gray-600">Material:</span>
                                        <span class="ml-2 font-medium">${product.filamentType}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-600">Time:</span>
                                        <span class="ml-2 font-medium">${product.printTime}h</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-600">Cost:</span>
                                        <span class="ml-2 font-medium">R${(product.materialCost + product.laborCost + product.operationalCost).toFixed(2)}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-600">Price:</span>
                                        <span class="ml-2 font-bold text-green-600">R${product.finalPrice.toFixed(2)}</span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderDesktopCalculator() {
            return '<div class="bg-white rounded-xl shadow-lg p-6">Desktop view coming soon...</div>';
        }

        function renderDesktopResults() {
            return '<div class="bg-white rounded-xl shadow-lg p-6">Results view coming soon...</div>';
        }

        function renderDesktopProducts() {
            return '<div class="bg-white rounded-xl shadow-lg p-6 mt-8">Products table coming soon...</div>';
        }

        // Event handlers
        function updateState(key, value) {
            state[key] = value;
            render();
        }

        function toggleMobileMenu(show) {
            state.showMobileMenu = show;
            render();
        }

        function exportProducts() {
            const dataStr = JSON.stringify(state.products, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = `3d-print-products-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        // PWA functions
        function installApp() {
            if (state.deferredPrompt) {
                state.deferredPrompt.prompt();
                state.deferredPrompt.userChoice.then((choiceResult) => {
                    state.deferredPrompt = null;
                    state.showInstallButton = false;
                    render();
                });
            }
        }

        // Initialize app
        function init() {
            loadFromStorage();
            
            // PWA setup
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                state.deferredPrompt = e;
                state.showInstallButton = true;
                render();
            });

            // Service worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('data:application/javascript;base64,' + btoa(`
                    const CACHE_NAME = '3d-print-calc-v1';
                    
                    self.addEventListener('install', (event) => {
                        console.log('Service Worker installing');
                        self.skipWaiting();
                    });

                    self.addEventListener('activate', (event) => {
                        console.log('Service Worker activated');
                        event.waitUntil(self.clients.claim());
                    });

                    self.addEventListener('fetch', (event) => {
                        if (event.request.method === 'GET') {
                            event.respondWith(
                                caches.match(event.request)
                                    .then((response) => {
                                        if (response) return response;
                                        return fetch(event.request).catch(() => {
                                            if (event.request.mode === 'navigate') {
                                                return new Response('<h1>App works offline</h1>', {
                                                    headers: { 'Content-Type': 'text/html' }
                                                });
                                            }
                                        });
                                    })
                            );
                        }
                    });
                `)).catch(console.log);
            }

            render();
        }

        // Start the app
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
